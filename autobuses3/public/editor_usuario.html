<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Editar Perfil | Onroute</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #4361ee;
    --primary-dark: #3a56d4;
    --secondary: #000000;
    --success: #4cc9f0;
    --danger: #0a0a0a;
    --warning: #f8961e;
    --light: #f8f9fa;
    --dark: #212529;
    --gray: #6c757d;
    --gray-light: #e9ecef;
    --border-radius: 12px;
    --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    --transition: all 0.3s ease;
  }
 
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
 
  body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    color: var(--dark);
    line-height: 1.6;
  }
 
  .mobile-app {
    width: 100%;
    max-width: 500px;
    background: white;
    border-radius: var(--border-radius);
    padding: 0;
    box-shadow: var(--box-shadow);
    overflow: hidden;
  }
 
  .app-header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: 25px 20px;
    text-align: center;
    position: relative;
  }
 
  .app-header::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 100%;
    height: 20px;
    background: white;
    border-radius: 20px 20px 0 0;
  }
 
  .app-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 5px;
  }
 
  .app-subtitle {
    font-size: 14px;
    font-weight: 400;
    opacity: 0.9;
  }
 
  .edit-form {
    padding: 30px 25px 25px;
  }
 
  /* Botón de regresar */
  .back-button {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    z-index: 2;
  }
 
  .back-button:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-50%) scale(1.1);
  }
 
  /* Foto de perfil */
  .profile-picture {
    text-align: center;
    margin-bottom: 25px;
    position: relative;
    z-index: 1;
  }
 
  .profile-img-container {
    display: inline-block;
    position: relative;
    border-radius: 50%;
    padding: 4px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  }
 
  .profile-img {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid white;
    display: block;
    cursor: pointer;
    transition: var(--transition);
  }
 
  .profile-img:hover {
    transform: scale(1.03);
  }
 
  .change-photo-btn {
    background: white;
    color: var(--primary);
    border: 1px solid var(--gray-light);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    margin-top: 12px;
    transition: var(--transition);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }
 
  .change-photo-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }
 
  .input-group {
    margin-bottom: 20px;
  }
 
  .input-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--dark);
    font-size: 14px;
  }
 
  .input-group input {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid var(--gray-light);
    border-radius: 10px;
    font-size: 15px;
    box-sizing: border-box;
    transition: var(--transition);
    background: white;
  }
 
  .input-group input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
  }
 
  .input-group input:read-only {
    background-color: var(--gray-light);
    color: var(--gray);
    cursor: not-allowed;
  }
 
  .action-buttons {
    display: flex;
    gap: 12px;
    margin-top: 25px;
  }
 
  .btn {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
 
  .btn-primary {
    background: var(--primary);
    color: white;
  }
 
  .btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
  }
 
  .btn-secondary {
    background: white;
    color: var(--danger);
    border: 1px solid var(--gray-light);
  }
 
  .btn-secondary:hover {
    background: var(--danger);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(247, 37, 133, 0.3);
  }
 
  .btn-outline {
    background: white;
    color: var(--primary);
    border: 1px solid var(--primary);
  }
 
  .btn-outline:hover {
    background: var(--primary);
    color: white;
  }
 
  .status-container {
    margin-top: 20px;
    padding: 14px 16px;
    border-radius: 10px;
    font-weight: 500;
    display: none;
    font-size: 14px;
  }
 
  .status-success {
    background: rgba(76, 201, 240, 0.1);
    color: #0c5460;
    border: 1px solid rgba(76, 201, 240, 0.3);
  }
 
  .status-error {
    background: rgba(247, 37, 133, 0.1);
    color: #721c24;
    border: 1px solid rgba(247, 37, 133, 0.3);
  }
 
  .status-info {
    background: rgba(67, 97, 238, 0.1);
    color: #004085;
    border: 1px solid rgba(67, 97, 238, 0.3);
  }
 
  .login-message {
    text-align: center;
    padding: 50px 30px;
    background: white;
    border-radius: var(--border-radius);
  }
 
  .login-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 14px 28px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 20px;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
 
  .login-btn:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
  }
 
  .password-fields {
    display: none;
    margin-top: 20px;
    padding: 20px;
    background: rgba(67, 97, 238, 0.05);
    border-radius: 10px;
    border: 1px solid rgba(67, 97, 238, 0.2);
  }
 
  .input-with-icon {
    position: relative;
  }
 
  .input-with-icon i {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray);
    cursor: pointer;
    transition: var(--transition);
  }
 
  .input-with-icon i:hover {
    color: var(--primary);
  }
 
  .file-input {
    display: none;
  }
 
  /* Estilos para el rol del usuario */
  .user-role {
    text-align: center;
    margin-bottom: 25px;
  }
 
  .role-badge {
    display: inline-block;
    padding: 8px 18px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.5px;
  }
 
  .role-conductor {
    background: rgba(67, 97, 238, 0.1);
    color: var(--primary);
    border: 1px solid rgba(67, 97, 238, 0.3);
  }
 
  .role-pasajero {
    background: rgba(76, 201, 240, 0.1);
    color: #0c5460;
    border: 1px solid rgba(76, 201, 240, 0.3);
  }
 
  .role-admin {
    background: rgba(247, 37, 133, 0.1);
    color: var(--danger);
    border: 1px solid rgba(247, 37, 133, 0.3);
  }
 
  .section-title {
    font-size: 18px;
    font-weight: 600;
    margin: 25px 0 15px;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 10px;
  }
 
  .section-title:first-child {
    margin-top: 0;
  }
 
  .section-title i {
    color: var(--primary);
  }
 
  .divider {
    height: 1px;
    background: var(--gray-light);
    margin: 25px 0;
  }
 
  .login-message h3 {
    margin-bottom: 10px;
    color: var(--dark);
  }
 
  .login-message p {
    color: var(--gray);
    margin-bottom: 5px;
  }
</style>
</head>
<body>

<div class="mobile-app">
  <div class="app-header">
    <!-- Botón de regresar agregado aquí -->
    <button class="back-button" onclick="regresar()">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="app-title">Editar Perfil</div>
    <div class="app-subtitle">Actualiza tu información personal</div>
  </div>

  <div id="userForm" style="display:none;">
    <div class="edit-form">
            <div class="profile-picture">
        <div class="profile-img-container">
          <img id="profileImage" src="https://via.placeholder.com/120" alt="Foto de perfil" class="profile-img" onclick="document.getElementById('fileInput').click()">
        </div>
        <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="cambiarFotoPerfil(event)">
        <br>
        <button class="change-photo-btn" onclick="document.getElementById('fileInput').click()">
          <i class="fas fa-camera"></i> Cambiar foto
        </button>
      </div>

            <div class="user-role">
        <span id="roleBadge" class="role-badge"></span>
      </div>

      <div class="section-title">
        <i class="fas fa-user-circle"></i> Información Personal
      </div>

      <div class="input-group">
        <label><i class="fas fa-envelope"></i> Correo Electrónico</label>
        <input type="email" id="currentEmail" readonly>
      </div>

      <div class="input-group">
        <label for="fullName"><i class="fas fa-user"></i> Nombre Completo</label>
        <input type="text" id="fullName" placeholder="Ingresa tu nombre completo">
      </div>

      <div class="input-group">
        <label for="phoneNumber"><i class="fas fa-phone"></i> Número de Celular</label>
        <input type="tel" id="phoneNumber" placeholder="Ingresa tu número de celular">
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <i class="fas fa-lock"></i> Seguridad
      </div>

            <div class="action-buttons">
        <button class="btn btn-outline" onclick="mostrarCambioContrasena()">
          <i class="fas fa-key"></i> Cambiar Contraseña
        </button>
      </div>

            <div id="passwordFields" class="password-fields">
        <div class="input-group">
          <label><i class="fas fa-lock"></i> Contraseña Actual</label>
          <div class="input-with-icon">
            <input type="password" id="currentPassword" placeholder="Ingresa tu contraseña actual">
            <i class="fas fa-eye" onclick="togglePasswordVisibility('currentPassword', this)"></i>
          </div>
        </div>

        <div class="input-group">
          <label><i class="fas fa-key"></i> Nueva Contraseña</label>
          <div class="input-with-icon">
            <input type="password" id="newPassword" placeholder="Ingresa tu nueva contraseña">
            <i class="fas fa-eye" onclick="togglePasswordVisibility('newPassword', this)"></i>
          </div>
        </div>

        <div class="input-group">
          <label><i class="fas fa-check-circle"></i> Confirmar Contraseña</label>
          <div class="input-with-icon">
            <input type="password" id="confirmPassword" placeholder="Confirma tu nueva contraseña">
            <i class="fas fa-eye" onclick="togglePasswordVisibility('confirmPassword', this)"></i>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-secondary" onclick="cancelarCambioContrasena()">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button class="btn btn-primary" onclick="cambiarContraseña()">
            <i class="fas fa-check"></i> Actualizar
          </button>
        </div>
      </div>

      <div class="divider"></div>

            <div class="action-buttons">
        <button class="btn btn-primary" onclick="guardarCambios()">
          <i class="fas fa-save"></i> Guardar Cambios
        </button>
      </div>

      <div class="action-buttons">
        <button class="btn btn-secondary" onclick="cerrarSesion()">
          <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
        </button>
      </div>

      <div id="status" class="status-container"></div>
    </div>
  </div>

  <div id="loginMessage" class="login-message" style="display:none;">
    <h3>No estás autenticado</h3>
    <p>Para editar tu información de usuario, primero debes iniciar sesión.</p>
    <button class="login-btn" onclick="window.location.href='login.html'">
      <i class="fas fa-sign-in-alt"></i> Ir a Inicio de Sesión
    </button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCgBbH8LrjYGfCOg8sNBaLvekIbicQu_b0",
  authDomain: "bustrackeriot.firebaseapp.com",
  projectId: "bustrackeriot",
  storageBucket: "bustrackeriot.appspot.com",
  messagingSenderId: "263881969617",
  appId: "1:263881969617:web:5d09d1e49f6711f1461af0"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

const status = document.getElementById("status");
const userForm = document.getElementById("userForm");
const loginMessage = document.getElementById("loginMessage");
const fullNameInput = document.getElementById("fullName");
const phoneNumberInput = document.getElementById("phoneNumber");
const passwordFields = document.getElementById("passwordFields");
const profileImage = document.getElementById("profileImage");
const roleBadge = document.getElementById("roleBadge");

// Variable global para almacenar la nueva foto temporalmente
let nuevaFotoArchivo = null;

// Función para regresar a la página anterior
function regresar() {
  // Puedes personalizar esta función para redirigir a donde necesites
  // Por ejemplo, redirigir al dashboard o página principal
  window.location.href = 'visor_autobuses.html'; // Cambia esto por tu URL de destino
}

function updateStatus(msg, type){
  status.style.display="block";
  status.textContent=msg;
  status.className=`status-container status-${type}`;
  setTimeout(()=>{status.style.display="none";},5000);
}

// Función para mostrar/ocultar contraseñas
function togglePasswordVisibility(inputId, icon) {
  const input = document.getElementById(inputId);
  if (input.type === 'password') {
    input.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    input.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

// Mostrar campos para cambiar contraseña
function mostrarCambioContrasena() {
  passwordFields.style.display = 'block';
}

// Cancelar cambio de contraseña
function cancelarCambioContrasena() {
  passwordFields.style.display = 'none';
  document.getElementById('currentPassword').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('confirmPassword').value = '';
}

// Cambiar foto de perfil
function cambiarFotoPerfil(event) {
  const file = event.target.files[0];
  if (file) {
    const user = auth.currentUser;
    if (!user) return;
   
    // Validar que sea una imagen
    if (!file.type.match('image.*')) {
      updateStatus("Por favor selecciona una imagen válida", "error");
      return;
    }
   
    // Mostrar preview
    const reader = new FileReader();
    reader.onload = function(e) {
      profileImage.src = e.target.result;
    };
    reader.readAsDataURL(file);
   
    // Guardar el archivo para subirlo después
    nuevaFotoArchivo = file;
   
    updateStatus("Foto cargada. Haz clic en 'Guardar Cambios' para guardarla.", "info");
  }
}

// Función para mostrar el rol del usuario
function mostrarRolUsuario(rol) {
  // Limpiar clases anteriores
  roleBadge.className = 'role-badge';
 
  // Configurar según el rol
  switch(rol) {
    case 'conductor':
      roleBadge.textContent = 'Conductor';
      roleBadge.classList.add('role-conductor');
      break;
    case 'pasajero':
      roleBadge.textContent = 'Pasajero';
      roleBadge.classList.add('role-pasajero');
      break;
    case 'admin':
      roleBadge.textContent = 'Administrador';
      roleBadge.classList.add('role-admin');
      break;
    default:
      roleBadge.textContent = 'Usuario';
      roleBadge.classList.add('role-pasajero');
  }
}

// Cargar datos del usuario
auth.onAuthStateChanged(user=>{
  if(user){
    userForm.style.display="block";
    loginMessage.style.display="none";
    document.getElementById('currentEmail').value=user.email;
   
    // Cargar datos desde Firebase Database
    db.ref('usuarios/'+user.uid).get().then(snapshot=>{
      if(snapshot.exists()){
        const userData = snapshot.val();
        if(userData.nombre) fullNameInput.value = userData.nombre;
        if(userData.telefono) phoneNumberInput.value = userData.telefono;
        if(userData.fotoPerfil) {
          profileImage.src = userData.fotoPerfil;
        } else {
          profileImage.src = "https://via.placeholder.com/120";
        }
     
        // Mostrar el rol del usuario
        if(userData.rol) {
          mostrarRolUsuario(userData.rol);
        } else {
          // Si no hay rol definido, establecer por defecto como pasajero
          mostrarRolUsuario('pasajero');
          // Guardar el rol por defecto en la base de datos
          db.ref('usuarios/'+user.uid).update({rol: 'pasajero'});
        }
      } else {
        // Si no existe el usuario en la base de datos, crear registro con rol por defecto
        const userData = {
          nombre: user.displayName || '',
          email: user.email,
          rol: 'pasajero', // Rol por defecto
          fechaCreacion: new Date().toISOString()
        };
        db.ref('usuarios/'+user.uid).set(userData);
        mostrarRolUsuario('pasajero');
      }
    });
  } else {
    userForm.style.display="none";
    loginMessage.style.display="block";
  }
});

// Función para reautenticar al usuario
function reautenticarUsuario(password) {
  const user = auth.currentUser;
  if (!user) throw new Error("No hay usuario autenticado");
 
  const credential = firebase.auth.EmailAuthProvider.credential(
    user.email,
    password
  );
 
  return user.reauthenticateWithCredential(credential);
}

// Cambiar contraseña
function cambiarContraseña(){
  const user = auth.currentUser;
  if(!user) return updateStatus("No hay usuario autenticado","error");

  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;

  // Validaciones
  if(!currentPassword) return updateStatus("Ingresa tu contraseña actual","error");
  if(!newPassword) return updateStatus("Ingresa la nueva contraseña","error");
  if(newPassword.length < 6) return updateStatus("La contraseña debe tener al menos 6 caracteres","error");
  if(newPassword !== confirmPassword) return updateStatus("Las contraseñas no coinciden","error");

  updateStatus("Actualizando contraseña...", "info");

  // Reautenticar y cambiar contraseña
  reautenticarUsuario(currentPassword)
    .then(() => {
      return user.updatePassword(newPassword);
    })
    .then(() => {
      updateStatus("Contraseña actualizada correctamente","success");
      cancelarCambioContrasena(); // Limpiar campos
    })
    .catch(error => {
      console.error("Error al cambiar contraseña:", error);
      if (error.code === 'auth/wrong-password') {
        updateStatus("Contraseña actual incorrecta","error");
      } else if (error.code === 'auth/requires-recent-login') {
        updateStatus("Necesitas reautenticarte. Cierra sesión y vuelve a iniciar sesión","error");
      } else {
        updateStatus("Error al cambiar contraseña: " + error.message, "error");
      }
    }); // Cierre del .catch
} // Cierre de la función cambiarContraseña


// --- FUNCIONES AÑADIDAS ---

// Función para guardar cambios (Nombre, Teléfono y FOTO DE PERFIL)
// Reemplaza la función guardarCambios con esta versión
function guardarCambios() {
  const user = auth.currentUser;
  if (!user) return updateStatus("No estás autenticado.", "error");

  updateStatus("Guardando cambios...", "info");

  const fullName = fullNameInput.value.trim();
  const phoneNumber = phoneNumberInput.value.trim();

  if (!fullName) {
    updateStatus("Por favor ingresa tu nombre completo", "error");
    return;
  }

  const updates = {
    nombre: fullName,
    telefono: phoneNumber,
    ultimaActualizacion: new Date().toISOString()
  };

  // Si hay una nueva foto, convertir a Base64
  if (nuevaFotoArchivo) {
    updateStatus("Procesando imagen...", "info");
    
    const reader = new FileReader();
    reader.onload = function(e) {
      // Guardar la imagen como Base64 en la base de datos
      updates.fotoPerfil = e.target.result;
      
      // Guardar todo en la base de datos
      guardarEnBaseDeDatos(updates);
    };
    reader.onerror = function() {
      updateStatus("Error al procesar la imagen", "error");
    };
    reader.readAsDataURL(nuevaFotoArchivo);
  } else {
    // Solo guardar datos sin foto nueva
    guardarEnBaseDeDatos(updates);
  }
}

// Función auxiliar para guardar en la base de datos
function guardarEnBaseDeDatos(updates) {
  const user = auth.currentUser;
  
  db.ref('usuarios/' + user.uid).update(updates)
    .then(() => {
      updateStatus("Perfil actualizado correctamente", "success");
      nuevaFotoArchivo = null;
    })
    .catch(error => {
      console.error("Error al guardar:", error);
      updateStatus("Error al guardar: " + error.message, "error");
    });
}

// También modifica la función cambiarFotoPerfil para mejor manejo
function cambiarFotoPerfil(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Validar que sea una imagen
  if (!file.type.match('image.*')) {
    updateStatus("Por favor selecciona una imagen válida", "error");
    return;
  }

  // Validar tamaño (máximo 500KB para Base64)
  if (file.size > 500 * 1024) {
    updateStatus("La imagen debe ser menor a 500KB para mejor rendimiento", "error");
    return;
  }

  // Mostrar preview inmediatamente
  const reader = new FileReader();
  reader.onload = function(e) {
    profileImage.src = e.target.result;
    updateStatus("Vista previa actualizada", "info");
  };
  reader.readAsDataURL(file);

  nuevaFotoArchivo = file;
}

// Función para cerrar sesión
function cerrarSesion() {
  auth.signOut()
    .then(() => {
      // Redirigir a la página de inicio de sesión
      window.location.href = 'login.html'; // Asegúrate de que esta sea tu página de login
    })
    .catch(error => {
      console.error("Error al cerrar sesión:", error);
      updateStatus("Error al cerrar sesión: " + error.message, "error");
    });
}

</script>
</body>
</html>