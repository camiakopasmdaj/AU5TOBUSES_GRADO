<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Visor de ruta TP10M</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="css/visor_autobuses.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* ‚úÖ NUEVO: Estilos para el bot√≥n de centrar bus activo */
    .action-button#centerActiveBus {
        background: #576fc0;
        color: white;
        border: none;
        border-radius: 8px;
        width: auto;
        min-width: 60px;
        height: 40px;
        font-size: 12px;
        font-weight: 600;
        display: none;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 0 10px;
        box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
        transition: all 0.3s ease;
    }

    .action-button#centerActiveBus:hover {
        background: #c0392b;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
    }

    .action-button#centerActiveBus i {
        font-size: 14px;
    }

    /* Estilos para el nuevo modal de permisos GPS */
    .gps-permission-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .gps-permission-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.4s ease;
      position: relative;
    }

    .gps-permission-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #3498db, #2980b9);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      animation: pulse 2s infinite;
    }

    .gps-permission-icon i {
      font-size: 36px;
      color: white;
    }

    .gps-permission-title {
      font-size: 24px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 15px;
      line-height: 1.3;
    }

    .gps-permission-text {
      font-size: 16px;
      color: #5a6c7d;
      line-height: 1.5;
      margin-bottom: 25px;
    }

    .gps-permission-features {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      text-align: left;
    }

    .gps-feature {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      font-size: 14px;
      color: #495057;
    }

    .gps-feature:last-child {
      margin-bottom: 0;
    }

    .gps-feature i {
      color: #27ae60;
      margin-right: 10px;
      font-size: 16px;
    }

    .gps-permission-buttons {
      display: flex;
      gap: 12px;
      flex-direction: column;
    }

    .gps-permission-btn {
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .gps-permission-btn.allow {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
    }

    .gps-permission-btn.allow:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
    }

    .gps-permission-btn.deny {
      background: #f8f9fa;
      color: #6c757d;
      border: 2px solid #e9ecef;
    }

    .gps-permission-btn.deny:hover {
      background: #e9ecef;
      transform: translateY(-1px);
    }

    .gps-permission-footer {
      margin-top: 20px;
      font-size: 12px;
      color: #95a5a6;
    }

    /* Animaciones */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Responsive */
    @media (max-width: 480px) {
      .gps-permission-content {
        padding: 25px 20px;
        margin: 10px;
      }
      
      .gps-permission-icon {
        width: 70px;
        height: 70px;
      }
      
      .gps-permission-icon i {
        font-size: 32px;
      }
      
      .gps-permission-title {
        font-size: 22px;
      }
      
      .gps-permission-text {
        font-size: 15px;
      }
    }

    /* Estilos adicionales para notificaciones mejoradas */
    .notification-item {
      display: flex;
      align-items: flex-start;
      padding: 12px;
      border-bottom: 1px solid #eee;
      background: white;
      transition: background-color 0.2s;
    }
    
    .notification-item:hover {
      background: #f8f9fa;
    }
    
    .notification-item.notification-warning {
      border-left: 4px solid #ffc107;
    }
    
    .notification-item.notification-error {
      border-left: 4px solid #dc3545;
    }
    
    .notification-item.notification-success {
      border-left: 4px solid #28a745;
    }
    
    .notification-item.notification-bus {
      border-left: 4px solid #007bff;
    }
    
    .notification-icon {
      margin-right: 12px;
      font-size: 18px;
      color: #6c757d;
    }
    
    .notification-warning .notification-icon {
      color: #ffc107;
    }
    
    .notification-error .notification-icon {
      color: #dc3545;
    }
    
    .notification-success .notification-icon {
      color: #28a745;
    }
    
    .notification-bus .notification-icon {
      color: #007bff;
    }
    
    .notification-content {
      flex: 1;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .notification-time {
      font-size: 12px;
      color: #6c757d;
      margin-top: 4px;
    }
    
    .notification-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }
    
    .notification-btn {
      padding: 4px 8px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .notification-btn.track {
      background-color: #007bff;
      color: white;
    }
    
    .notification-btn.track:hover {
      background-color: #0069d9;
    }
    
    .notification-btn.untrack {
      background-color: #dc3545;
      color: white;
    }
    
    .notification-btn.untrack:hover {
      background-color: #c82333;
    }
    
    .notification-badge {
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      position: absolute;
      top: -5px;
      right: -5px;
    }

    .nav-button.active {
      background: #ebf5fb;
      color: #3498db;
    }

    /* Estilos para iconos personalizados */
    .icono-inicio {
      background-color: #2ecc71;
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .icono-fin {
      background-color: #e74c3c;
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    /* NUEVO: Estilos para el contenedor de iconos del header */
    .header-icons {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-menu {
      position: relative;
    }

    .user-button {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .user-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      min-width: 180px;
      z-index: 1000;
      display: none;
      overflow: hidden;
    }

    .user-dropdown.show {
      display: block;
    }

    .user-dropdown-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      text-decoration: none;
      color: #333;
      transition: background-color 0.2s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-size: 14px;
      cursor: pointer;
    }

    .user-dropdown-item:hover {
      background-color: #f5f5f5;
    }

    .user-dropdown-item i {
      margin-right: 10px;
      width: 16px;
      text-align: center;
    }

    .user-dropdown-divider {
      height: 1px;
      background-color: #e0e0e0;
      margin: 0;
    }
    
    /* Estilos para el panel de notificaciones mejorado */
    .notification-panel {
      position: absolute;
      top: 100%;
      right: 10px;
      width: 320px;
      max-height: 400px;
      overflow-y: auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      display: none;
    }
    
    .notification-panel h3 {
      padding: 15px;
      margin: 0;
      border-bottom: 1px solid #eee;
      background: #f8f9fa;
      border-radius: 8px 8px 0 0;
    }
    
    .notification-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    
    .tracking-info {
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .tracking-info p {
      margin: 0 0 5px 0;
    }
    
    .tracking-buses {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .tracking-bus {
      background: #007bff;
      color: white;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 11px;
      display: flex;
      align-items: center;
    }
    
    .tracking-bus button {
      background: none;
      border: none;
      color: white;
      margin-left: 4px;
      cursor: pointer;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <!-- Nuevo Modal mejorado para permisos de GPS -->
  <div id="gpsPermissionModal" class="gps-permission-modal">
    <div class="gps-permission-content">
      <div class="gps-permission-icon">
        <i class="fas fa-location-dot"></i>
      </div>
      
      <h2 class="gps-permission-title">Permiso de Ubicaci√≥n</h2>
      
      <p class="gps-permission-text">
        Para brindarte la mejor experiencia y mostrarte los buses cercanos, necesitamos acceso a tu ubicaci√≥n.
      </p>
      
      <div class="gps-permission-features">
        <div class="gps-feature">
          <i class="fas fa-check-circle"></i>
          <span>Ver buses cerca de tu ubicaci√≥n actual</span>
        </div>
        <div class="gps-feature">
          <i class="fas fa-check-circle"></i>
          <span>Notificaciones cuando el bus est√© cerca</span>
        </div>
        <div class="gps-feature">
          <i class="fas fa-check-circle"></i>
          <span>Rutas optimizadas desde tu posici√≥n</span>
        </div>
        <div class="gps-feature">
          <i class="fas fa-check-circle"></i>
          <span>Ver tu ubicaci√≥n en el mapa</span>
        </div>
      </div>
      
      <div class="gps-permission-buttons">
        <button id="allowGps" class="gps-permission-btn allow">
          <i class="fas fa-check"></i>
          Permitir Ubicaci√≥n
        </button>
        <button id="denyGps" class="gps-permission-btn deny">
          <i class="fas fa-times"></i>
          No Permitir
        </button>
      </div>
      
      <div class="gps-permission-footer">
        Tu privacidad es importante. Solo usamos tu ubicaci√≥n para mejorar tu experiencia en la app.
      </div>
    </div>
  </div>

  <div class="mobile-app">
    <div class="app-header">
      <div class="app-title">
      <img src="imagenes/logo.jpg" alt="Logo" class="logo-img" style="width: 30px; height: 30px; border-radius: 5px; margin-right: 10px;">
      <span>Onroute</span>
  </div>
      
      <div class="header-icons">
        <div class="notification-bell" id="bell">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notificationCount">0</span>
        </div>
        
        <!-- NUEVO: Men√∫ de usuario -->
        <div class="user-menu" id="userMenu">
          <button class="user-button" id="userButton">
            <i class="fas fa-user-circle"></i>
          </button>
          <div class="user-dropdown" id="userDropdown">
            <a href="editor_usuario.html" class="user-dropdown-item">
              <i class="fas fa-user-edit"></i>
              Editar usuario
            </a>
            <div class="user-dropdown-divider"></div>
            <button class="user-dropdown-item" id="logoutButton">
              
              <i class="fas fa-sign-out-alt"></i>
              Cerrar sesi√≥n
            </button>
          </div>
        </div>
      </div>
      
      <div class="notification-panel" id="notificationPanel">
        <h3>Notificaciones</h3>
        <div class="tracking-info" id="trackingInfo">
          <p><strong>Buses con notificaci√≥n activa:</strong></p>
          <div class="tracking-buses" id="trackingBuses">
            <!-- Aqu√≠ se mostrar√°n los buses con seguimiento activo -->
          </div>
        </div>
        <ul class="notification-list" id="notifList"></ul>
      </div>
    </div>
    
    <div class="map-container">
      <div id="map"></div>
      
      <!-- ELIMINADO: Bot√≥n de sonido innecesario -->
      
      <div class="status-bar">
        <div class="connection-status">
          <span id="connection-icon">üü°</span>
          <span id="connection-status">Conectando...</span>
        </div>
        <div class="update-status">
          <i class="far fa-clock"></i>
          <span id="update-status">--:--:--</span>
        </div>
      </div>
      
      <div class="floating-buttons">
        <button class="action-button" id="locateMe">
          <i class="fas fa-location-arrow"></i>
        </button>
        <button class="action-button" id="zoomIn">
          <i class="fas fa-plus"></i>
        </button>
        <button class="action-button" id="zoomOut">
          <i class="fas fa-minus"></i>
        </button>
        <!-- ‚úÖ NUEVO: Bot√≥n para centrar en bus activo -->
        <button class="action-button" id="centerActiveBus">
            <i class="fas fa-bus"></i>
        </button>
      </div>
    </div>
    
    <div class="bottom-nav">
      <button class="nav-button active" id="verBuses">
        <i class="fas fa-bus"></i> Ver bus TP1OM
      </button>
      <button class="nav-button" id="verTrazado">
        <i class="fas fa-route"></i> Ver Ruta
      </button>
      <button class="nav-button" onclick="location.href='destino.html'">
        <i class="fas fa-map-marker-alt"></i> Mi destino
      </button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  
  <script>
    // Configuraci√≥n inicial para m√≥viles
    const config = {
      updateInterval: 1000,
      smoothMovement: true,
      movementThreshold: 0.00001,
      maxHistoryPoints: 10,
      notificationDistance: 0.2,
      defaultZoom: 15,
      userZoom: 16,
      busInactivityTimeout: 30000, // 30 segundos
      retainedMessages: true,
      // ‚úÖ NUEVO: Control para centrado autom√°tico
      autoCenterOnBus: false // Cambiado a false para evitar zoom autom√°tico
    };

    // Inicializar mapa centrado en Popay√°n
    const map = L.map('map', {
      zoomControl: false,
      preferCanvas: true
    }).setView([2.4369, -76.6131], config.defaultZoom);

    // A√±adir control de zoom para m√≥viles (posici√≥n mejorada)
    L.control.zoom({
      position: 'topleft'
    }).addTo(map);

    // Capa del mapa
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Icono personalizado para autobuses
  const busIcon = L.icon({
  iconUrl: 'imagenes/image.png?v=1',  // ‚úÖ usa esta ruta
  iconSize: [45, 45],             // tama√±o del logo
  iconAnchor: [22, 45],
  popupAnchor: [0, -40],
  className: 'bus-logo'
});

    // ‚úÖ NUEVO: Iconos personalizados para inicio y fin de ruta
    const inicioIcon = L.divIcon({
      className: 'icono-inicio',
      html: '<div style="width: 20px; height: 20px; background: #2ecc71; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });

    const finIcon = L.divIcon({
      className: 'icono-fin',
      html: '<div style="width: 20px; height: 20px; background: #e74c3c; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });

    // Variables de estado
    const buses = {};
    const notificacionesActivas = {};
    const lastKnownPositions = {};
    const busPositionHistory = {};
    const busTrazados = {}; // Para guardar los trazados de cada bus
    
    // ‚úÖ MEJORADO: Control m√°s robusto para notificaciones de disponibilidad
    const busesNotificados = new Set();
    let lastNotificationTime = {}; // Para controlar tiempo entre notificaciones
    
    // ‚úÖ NUEVO: Variables para control de centrado
    let activeBusId = null;
    let userZoomInteracted = false; // Para saber si el usuario hizo zoom manualmente
    
    let lastUpdateTime = null;
    let userCoords = null;
    let userMarker = null;
    let notificationCount = 0;
    let audioEnabled = false;
    let geolocationWatchId = null;
    let routePolyline = null;
    let routeMarkers = [];
    let mostrarRuta = false;

    // Elementos de la UI
    const bellIcon = document.getElementById('bell');
    const notificationPanel = document.getElementById('notificationPanel');
    const notificationCountEl = document.getElementById('notificationCount');
    const connectionStatus = document.getElementById('connection-status');
    const connectionIcon = document.getElementById('connection-icon');
    const updateStatus = document.getElementById('update-status');
    const locateMeBtn = document.getElementById('locateMe');
    const zoomInBtn = document.getElementById('zoomIn');
    const zoomOutBtn = document.getElementById('zoomOut');
    const centerActiveBusBtn = document.getElementById('centerActiveBus'); // ‚úÖ NUEVO
    const gpsPermissionModal = document.getElementById('gpsPermissionModal');
    const allowGpsBtn = document.getElementById('allowGps');
    const denyGpsBtn = document.getElementById('denyGps');
    const verBusesBtn = document.getElementById('verBuses');
    const verTrazadoBtn = document.getElementById('verTrazado');
    const trackingInfo = document.getElementById('trackingInfo');
    const trackingBuses = document.getElementById('trackingBuses');
    
    // NUEVO: Elementos del men√∫ de usuario
    const userMenu = document.getElementById('userMenu');
    const userButton = document.getElementById('userButton');
    const userDropdown = document.getElementById('userDropdown');
    const logoutButton = document.getElementById('logoutButton');

    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCgBbH8LrjYGfCOg8sNBaLvekIbicQu_b0",
      authDomain: "bustrackeriot.firebaseapp.com",
      databaseURL: "https://bustrackeriot-default-rtdb.firebaseio.com",
      projectId: "bustrackeriot",
      storageBucket: "bustrackeriot.appspot.com",
      messagingSenderId: "263881969617",
      appId: "1:263881969617:web:5d09d1e49f6711f1461af0"
    };

    // Inicializar Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ‚úÖ MODIFICADO: Centrar mapa en el bus SOLO cuando se solicite
    function centrarEnBus(busId, lat, lon) {
        if (!config.autoCenterOnBus) return; // No centrar autom√°ticamente
        
        // Centrar el mapa en la posici√≥n del bus con un zoom adecuado
        map.setView([lat, lon], config.userZoom);
        
        // Abrir el popup del bus para mostrar informaci√≥n
        if (buses[busId] && buses[busId].marker) {
            buses[busId].marker.openPopup();
        }
        
        console.log(`üìç Mapa centrado en bus ${busId}`);
        activeBusId = busId;
        
        // ‚úÖ Mostrar bot√≥n para centrar en bus activo
        centerActiveBusBtn.style.display = 'block';
        centerActiveBusBtn.innerHTML = `<i class="fas fa-bus"></i> ${busId}`;
    }

    // ‚úÖ NUEVA FUNCI√ìN: Centrar en bus activo manualmente
    function centrarEnBusActivo() {
        if (activeBusId && buses[activeBusId]) {
            const bus = buses[activeBusId];
            const lastPos = bus.positions[bus.positions.length - 1];
            if (lastPos) {
                map.setView(lastPos.position, config.userZoom);
                bus.marker.openPopup();
            }
        }
    }

    // NUEVO: Funcionalidad del men√∫ de usuario
    userButton.addEventListener('click', function(e) {
      e.stopPropagation();
      userDropdown.classList.toggle('show');
    });

    logoutButton.addEventListener('click', function() {
  firebase.auth().signOut()
    .then(() => {
      showAlert('success', 'Sesi√≥n cerrada correctamente');
      localStorage.clear(); // Limpia datos del usuario
      sessionStorage.clear();
      setTimeout(() => {
        window.location.href = 'login.html'; // Redirige al login
      }, 1500);
    })
    .catch((error) => {
      console.error('Error al cerrar sesi√≥n:', error);
      showAlert('error', 'No se pudo cerrar la sesi√≥n');
    });
});

    // Cerrar men√∫s al hacer clic fuera de ellos
    document.addEventListener('click', function(event) {
      if (!bellIcon.contains(event.target) && !notificationPanel.contains(event.target)) {
        notificationPanel.style.display = 'none';
      }
      
      // NUEVO: Cerrar men√∫ de usuario al hacer clic fuera
      if (!userMenu.contains(event.target)) {
        userDropdown.classList.remove('show');
      }
    });

    // ‚úÖ NUEVO: Detectar interacci√≥n de zoom del usuario
    map.on('zoomstart', function() {
      userZoomInteracted = true;
      config.autoCenterOnBus = false; // Desactivar centrado autom√°tico cuando el usuario hace zoom
    });

    // ‚úÖ NUEVO: Event listener para bot√≥n de centrado manual
    centerActiveBusBtn.addEventListener('click', centrarEnBusActivo);

    // Funci√≥n para actualizar la informaci√≥n de seguimiento en el panel de notificaciones
    function updateTrackingInfo() {
      const activeBuses = Object.keys(notificacionesActivas);
      
      if (activeBuses.length === 0) {
        trackingInfo.style.display = 'none';
      } else {
        trackingInfo.style.display = 'block';
        trackingBuses.innerHTML = '';
        
        activeBuses.forEach(busId => {
          const busElement = document.createElement('div');
          busElement.className = 'tracking-bus';
          busElement.innerHTML = `
            ${busId}
            <button onclick="desactivarNotificacionDesdePanel('${busId}')" title="Cancelar notificaci√≥n">
              <i class="fas fa-times"></i>
            </button>
          `;
          trackingBuses.appendChild(busElement);
        });
      }
    }

    // ‚úÖ FUNCI√ìN SIMPLE: Actualizar marcador del usuario
    function updateUserLocation(lat, lon) {
      if (!userMarker) {
        // Crear marcador del usuario con el icono est√°ndar de Leaflet
        userMarker = L.marker([lat, lon]).addTo(map);
        userMarker.bindPopup(`
          <div style="text-align: center;">
            <i class="fas fa-user" style="color: #2ecc71; font-size: 20px;"></i>
            <br>
            <strong>Tu ubicaci√≥n</strong>
            <br>
            <small>Actualizado: ${new Date().toLocaleTimeString()}</small>
          </div>
        `);
      } else {
        // Actualizar posici√≥n existente
        userMarker.setLatLng([lat, lon]);
        
        // Actualizar popup
        userMarker.getPopup().setContent(`
          <div style="text-align: center;">
            <i class="fas fa-user" style="color: #2ecc71; font-size: 20px;"></i>
            <br>
            <strong>Tu ubicaci√≥n</strong>
            <br>
            <small>Actualizado: ${new Date().toLocaleTimeString()}</small>
          </div>
        `);
      }
    }

    // Funci√≥n para crear o actualizar trazado del bus
    function crearOActualizarTrazado(busId, lat, lon) {
      if (!busTrazados[busId]) {
        // Crear nuevo trazado para el bus
        busTrazados[busId] = {
          polyline: L.polyline([[lat, lon]], {
            color: getColorParaBus(busId),
            weight: 4,
            opacity: 0.7,
            className: `trazado-bus-${busId}`
          }).addTo(map),
          puntos: [[lat, lon]],
          ultimaActualizacion: Date.now()
        };
      } else {
        // Actualizar trazado existente
        const trazado = busTrazados[busId];
        trazado.puntos.push([lat, lon]);
        trazado.polyline.setLatLngs(trazado.puntos);
        trazado.ultimaActualizacion = Date.now();
        
        // Limitar a 100 puntos m√°ximo para evitar sobrecarga
        if (trazado.puntos.length > 100) {
          trazado.puntos.shift(); // Eliminar el punto m√°s antiguo
        }
      }
    }

    // Funci√≥n para generar color √∫nico por bus
    function getColorParaBus(busId) {
      const colores = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#d35400', '#c0392b'];
      const index = parseInt(busId) % colores.length || 0;
      return colores[index];
    }

    // Funci√≥n para limpiar trazados de buses inactivos
    function limpiarTrazadosInactivos() {
      const ahora = Date.now();
      const tiempoLimite = 30000; // 30 segundos
      
      for (const busId in busTrazados) {
        const trazado = busTrazados[busId];
        const tiempoInactivo = ahora - trazado.ultimaActualizacion;
        
        if (tiempoInactivo > tiempoLimite) {
          // Eliminar trazado del bus inactivo
          if (trazado.polyline) {
            map.removeLayer(trazado.polyline);
          }
          delete busTrazados[busId];
          console.log(`üóëÔ∏è Trazado eliminado para bus ${busId} (inactivo por ${tiempoInactivo/1000}s)`);
        }
      }
    }

    // Mostrar/ocultar la ruta TP10M
    function toggleRuta() {
      if (mostrarRuta) {
        // Ocultar ruta
        if (routePolyline) {
          map.removeLayer(routePolyline);
          routePolyline = null;
        }
        routeMarkers.forEach(marker => map.removeLayer(marker));
        routeMarkers = [];
        mostrarRuta = false;
        verTrazadoBtn.classList.remove('active');
        verBusesBtn.classList.add('active');
      } else {
        // Mostrar ruta
        cargarYMostrarRuta();
        mostrarRuta = true;
        verTrazadoBtn.classList.add('active');
        verBusesBtn.classList.remove('active');
      }
    }

    // Cargar y mostrar la ruta TP10M desde Firebase
    function cargarYMostrarRuta() {
      const rutaRef = db.ref('rutas/TP10M');
      rutaRef.once('value').then((snapshot) => {
        const puntos = snapshot.val();
        if (puntos && puntos.length > 0) {
          // Crear polil√≠nea
          routePolyline = L.polyline(puntos, { 
            color: '#3498db', 
            weight: 6,
            opacity: 0.7
          }).addTo(map);
          
          // ‚úÖ MODIFICADO: A√±adir marcadores de inicio y fin con nuevos iconos
          const startMarker = L.marker(puntos[0], {
            icon: inicioIcon
          }).addTo(map).bindPopup(`
            <div style="text-align: center;">
              <i class="fas fa-play-circle" style="color: #2ecc71; font-size: 20px;"></i>
              <br>
              <strong>Inicio Ruta TP10M</strong>
            </div>
          `);
          
          const endMarker = L.marker(puntos[puntos.length-1], {
            icon: finIcon
          }).addTo(map).bindPopup(`
            <div style="text-align: center;">
              <i class="fas fa-flag-checkered" style="color: #e74c3c; font-size: 20px;"></i>
              <br>
              <strong>Fin Ruta TP10M</strong>
            </div>
          `);
          
          routeMarkers = [startMarker, endMarker];
          
          // Ajustar vista al trazado
          map.fitBounds(routePolyline.getBounds());
        }
      }).catch((error) => {
        console.error("Error cargando ruta:", error);
        // Si hay error, usar ruta por defecto
        mostrarRutaPorDefecto();
      });
    }

    // Ruta por defecto en caso de error
    function mostrarRutaPorDefecto() {
      const puntosRuta = [
        [2.4569, -76.6331],
        [2.4519, -76.6281],
        [2.4469, -76.6231],
        [2.4419, -76.6181],
        [2.4369, -76.6131],
        [2.4319, -76.6081],
        [2.4269, -76.6031],
        [2.4219, -76.5981],
        [2.4169, -76.5931]
      ];
      
      routePolyline = L.polyline(puntosRuta, { 
        color: '#3498db', 
        weight: 6,
        opacity: 0.7
      }).addTo(map);
      
      // ‚úÖ MODIFICADO: Marcadores con nuevos iconos
      const startMarker = L.marker(puntosRuta[0], {
        icon: inicioIcon
      }).addTo(map).bindPopup(`
        <div style="text-align: center;">
          <i class="fas fa-play-circle" style="color: #2ecc71; font-size: 20px;"></i>
          <br>
          <strong>Inicio Ruta TP10M</strong>
        </div>
      `);
      
      const endMarker = L.marker(puntosRuta[puntos.length-1], {
        icon: finIcon
      }).addTo(map).bindPopup(`
        <div style="text-align: center;">
          <i class="fas fa-flag-checkered" style="color: #e74c3c; font-size: 20px;"></i>
          <br>
          <strong>Fin Ruta TP10M</strong>
        </div>
      `);
      
      routeMarkers = [startMarker, endMarker];
      map.fitBounds(routePolyline.getBounds());
    }

    // Event listeners para los botones de navegaci√≥n
    verBusesBtn.addEventListener('click', function() {
      if (mostrarRuta) {
        toggleRuta();
      }
    });

    verTrazadoBtn.addEventListener('click', function() {
      if (!mostrarRuta) {
        toggleRuta();
      }
    });

    // NUEVA FUNCI√ìN MEJORADA PARA SOLICITAR PERMISOS DE GEOLOCALIZACI√ìN
    function requestGeolocationPermission() {
      // Mostrar el modal mejorado
      gpsPermissionModal.style.display = 'flex';
      
      // Configurar evento para permitir GPS
      allowGpsBtn.addEventListener('click', function() {
        gpsPermissionModal.style.display = 'none';
        startGeolocation();
      });
      
      // Configurar evento para denegar GPS
      denyGpsBtn.addEventListener('click', function() {
        gpsPermissionModal.style.display = 'none';
        showAlert('warning', 'La funcionalidad de ubicaci√≥n est√° limitada. Algunas caracter√≠sticas no estar√°n disponibles.');
      });
      
      // Intentar obtener ubicaci√≥n autom√°ticamente (para navegadores que ya tienen permisos)
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function(position) {
            // Si ya tiene permisos, ocultar el modal y empezar
            gpsPermissionModal.style.display = 'none';
            startGeolocation();
          },
          function(error) {
            // El modal ya est√° mostr√°ndose, no hacer nada
            console.log("Esperando que el usuario conceda permisos...");
          }
        );
      } else {
        gpsPermissionModal.style.display = 'none';
        showAlert('error', 'Tu navegador no soporta geolocalizaci√≥n.');
      }
    }

    // ‚úÖ MODIFICADA: Funci√≥n para iniciar la geolocalizaci√≥n - ahora muestra la ubicaci√≥n
    function startGeolocation() {
      if (navigator.geolocation) {
        geolocationWatchId = navigator.geolocation.watchPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            userCoords = [lat, lon];
            console.log("Ubicaci√≥n del usuario actualizada:", userCoords);
            
            // ‚úÖ ACTUALIZAR MARCADOR DEL USUARIO
            updateUserLocation(lat, lon);
            
            
          },
          (error) => {
            console.error("Error de geolocalizaci√≥n:", error);
            handleGeolocationError(error);
          },
          {
            enableHighAccuracy: true,
            maximumAge: 10000,
            timeout: 15000
          }
        );
      } else {
        showAlert('error', 'La geolocalizaci√≥n no es compatible con tu navegador.');
      }
    }

    // ‚úÖ MODIFICADO: Procesar datos del bus - SIN enfoque autom√°tico
    function processBusData(busId, lat, lon, timestamp) {
      createOrUpdateBusMarker(busId, lat, lon, timestamp, false);
      updateBusPopup(busId);
      
      // ‚úÖ ACTUALIZAR TRAZADO EN TIEMPO REAL (siempre activo)
      crearOActualizarTrazado(busId, lat, lon);
      
      // ‚ùå ELIMINADO: Centrado autom√°tico en el bus
      // centrarEnBus(busId, lat, lon);
    }

    // Crear o actualizar marcador de bus
    function createOrUpdateBusMarker(busId, lat, lon, timestamp, isHistorical = false) {
      const newPos = [lat, lon];
      
      if (!buses[busId]) {
        buses[busId] = {
          marker: L.marker(newPos, { 
            icon: busIcon,
            title: `Bus ${busId}`
          }).addTo(map),
          positions: [],
          lastUpdated: timestamp || Date.now(),
          isHistorical: isHistorical,
          notifiedStopped: false,
          notifiedAvailable: false // Nueva propiedad para controlar notificaci√≥n de disponibilidad
        };
        
        busPositionHistory[busId] = [];
      } else {
        if (buses[busId].isHistorical && !isHistorical) {
          buses[busId].isHistorical = false;
        }
        
        buses[busId].lastUpdated = timestamp || Date.now();
        
        if (!busPositionHistory[busId]) {
          busPositionHistory[busId] = [];
        }
        
        const currentPositionKey = `${lat.toFixed(6)},${lon.toFixed(6)}`;
        busPositionHistory[busId].push({
          positionKey: currentPositionKey,
          timestamp: Date.now()
        });
        
        // Mantener solo √∫ltimos 10 segundos de historial
        busPositionHistory[busId] = busPositionHistory[busId].filter(
          pos => Date.now() - pos.timestamp <= 10000
        );
        
        if (shouldUpdatePosition(buses[busId].positions, newPos)) {
          buses[busId].positions.push({
            position: newPos,
            timestamp: Date.now()
          });
          
          if (buses[busId].positions.length > config.maxHistoryPoints) {
            buses[busId].positions.shift();
          }
          
          updateBusPosition(busId, newPos);
        }
      }
      
      saveLastKnownPosition(busId, lat, lon, timestamp);
    }

    // MODIFICADO: Limpiar buses inactivos - ahora tambi√©n limpia trazados autom√°ticamente
    setInterval(() => {
      const now = Date.now();
      
      for (const busId in buses) {
        if (!buses[busId].isHistorical && now - buses[busId].lastUpdated > config.busInactivityTimeout) {
          map.removeLayer(buses[busId].marker);
          delete buses[busId];
          delete notificacionesActivas[busId];
          delete busPositionHistory[busId];
          // ‚úÖ Tambi√©n eliminar de busesNotificados cuando el bus se vuelve inactivo
          busesNotificados.delete(busId);
          delete lastNotificationTime[busId];
          
          // ‚úÖ Ocultar bot√≥n de centrado si era el bus activo
          if (activeBusId === busId) {
            activeBusId = null;
            centerActiveBusBtn.style.display = 'none';
          }
        }
        
        if (buses[busId].isHistorical && now - buses[busId].lastUpdated > 300000) {
          map.removeLayer(buses[busId].marker);
          delete buses[busId];
          delete notificacionesActivas[busId];
          delete busPositionHistory[busId];
          // ‚úÖ Tambi√©n eliminar de busesNotificados cuando el bus se vuelve inactivo
          busesNotificados.delete(busId);
          delete lastNotificationTime[busId];
          
          // ‚úÖ Ocultar bot√≥n de centrado si era el bus activo
          if (activeBusId === busId) {
            activeBusId = null;
            centerActiveBusBtn.style.display = 'none';
          }
        }
      }
      
      // ‚úÖ LIMPIAR TRAZADOS DE BUSES INACTIVOS (autom√°tico)
      limpiarTrazadosInactivos();
    }, 10000);

    // Funci√≥n para manejar errores de geolocalizaci√≥n
    function handleGeolocationError(error) {
      switch(error.code) {
        case error.PERMISSION_DENIED:
          showAlert('error', 'Permiso de ubicaci√≥n denegado. Puedes activarlo en la configuraci√≥n de tu navegador.');
          break;
        case error.POSITION_UNAVAILABLE:
          showAlert('error', 'La informaci√≥n de ubicaci√≥n no est√° disponible.');
          break;
        case error.TIMEOUT:
          showAlert('error', 'La solicitud de ubicaci√≥n ha expirado.');
          break;
        default:
          showAlert('error', 'Error desconocido al obtener la ubicaci√≥n.');
          break;
      }
    }

    // Configuraci√≥n de audio
    const alertSound = new Audio('https://www.soundjay.com/buttons/sounds/beep-07.mp3');
    alertSound.preload = 'auto';
    
    // Guardar √∫ltima posici√≥n conocida de un bus
    function saveLastKnownPosition(busId, lat, lon, timestamp) {
      lastKnownPositions[busId] = {
        lat: lat,
        lon: lon,
        timestamp: timestamp || Date.now()
      };
      
      localStorage.setItem('lastKnownBusPositions', JSON.stringify(lastKnownPositions));
    }
    
    function playNotificationSound() {
      if (!audioEnabled) return;
      
      try {
        alertSound.currentTime = 0;
        alertSound.volume = 0.7;
        alertSound.play().catch(e => console.log('No se pudo reproducir sonido:', e));
      } catch (e) {
        console.error('Error al reproducir sonido:', e);
      }
    }

    // Gesti√≥n de notificaciones
    bellIcon.addEventListener('click', function(e) {
      e.stopPropagation();
      notificationPanel.style.display = notificationPanel.style.display === 'block' ? 'none' : 'block';
      updateTrackingInfo();
    });

    // ‚úÖ MEJORADA: Funci√≥n de notificaciones con control m√°s estricto
    function addNotification(message, type = 'info', busId = null) {
      // ‚úÖ Control adicional para evitar notificaciones duplicadas en m√≥vil
      const now = Date.now();
      const notificationKey = `${type}-${busId}-${message}`;
      
      if (lastNotificationTime[notificationKey]) {
        const timeSinceLast = now - lastNotificationTime[notificationKey];
        // Solo permitir notificaciones del mismo tipo cada 30 segundos
        if (timeSinceLast < 30000) {
          console.log(`‚è∞ Notificaci√≥n duplicada evitada: ${notificationKey}`);
          return;
        }
      }
      
      lastNotificationTime[notificationKey] = now;

      const li = document.createElement("li");
      li.className = `notification-item notification-${type}`;
      
      // Definir iconos seg√∫n el tipo de notificaci√≥n
      let icon = 'info-circle';
      if (type === 'warning') icon = 'exclamation-triangle';
      if (type === 'error') icon = 'exclamation-circle';
      if (type === 'success') icon = 'check-circle';
      if (type === 'bus') icon = 'bus';
      
      // Determinar si mostrar botones de seguimiento
      let actionButtons = '';
      if (busId && type === 'bus') {
        const isTracking = notificacionesActivas[busId];
        actionButtons = `
          <div class="notification-actions">
            <button class="notification-btn ${isTracking ? 'untrack' : 'track'}" 
                    onclick="${isTracking ? `desactivarNotificacion('${busId}')` : `activarNotificacion('${busId}')`}">
              ${isTracking ? 'Cancelar notificaci√≥n' : 'Notificarme cuando est√© cerca'}
            </button>
          </div>
        `;
      }
      
      li.innerHTML = `
        <div class="notification-icon">
          <i class="fas fa-${icon}"></i>
        </div>
        <div class="notification-content">
          ${message}
          <div class="notification-time">${new Date().toLocaleTimeString()}</div>
          ${actionButtons}
        </div>
      `;
      
      document.getElementById("notifList").prepend(li);
      
      // Actualizar contador
      notificationCount++;
      notificationCountEl.textContent = notificationCount;
      notificationCountEl.style.display = 'flex';
      
      // Resaltar campana
      bellIcon.querySelector('i').style.color = "#ffdd59";
      
      // Reproducir sonido
      playNotificationSound();
      
      // Notificaci√≥n nativa si est√° disponible
      if ("Notification" in window && Notification.permission === "granted") {
        new Notification("Visor de Ruta TP10M", {
          body: message.replace(/<[^>]*>/g, ''),
          icon: "https://cdn-icons-png.flaticon.com/512/61/61235.png"
        });
      }
    }

    // ‚úÖ MODIFICADO: Bot√≥n "Localizarme" - ahora centra en la ubicaci√≥n del usuario
    locateMeBtn.addEventListener('click', function() {
      if (userCoords) {
        map.setView(userCoords, config.userZoom);
        if (userMarker) {
          userMarker.openPopup();
        } else {
          showAlert('info', 'Tu ubicaci√≥n se est√° cargando. Por favor espera un momento.');
        }
      } else {
        showAlert('error', 'No se pudo obtener tu ubicaci√≥n. Verifica que tengas los permisos de ubicaci√≥n activados.');
      }
    });

    zoomInBtn.addEventListener('click', function() {
      map.zoomIn();
    });

    zoomOutBtn.addEventListener('click', function() {
      map.zoomOut();
    });

    // Conexi√≥n MQTT con mensajes retenidos
    const mqttOptions = {
      username: "busTrackerUser",
      password: "311411Camil@",
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 1000,
      keepalive: 60
    };

    const client = mqtt.connect("wss://8d9a31655be84e56b5601620210f24ac.s1.eu.hivemq.cloud:8884/mqtt", mqttOptions);
    
    client.on("connect", () => {
      console.log("Conectado al broker MQTT");
      connectionStatus.textContent = "Conectado";
      connectionIcon.textContent = "üü¢";
      
      client.subscribe("buses/#", { qos: 1 }, (err) => {
       if (!err) {
       console.log("Suscripci√≥n exitosa a buses/#");
       }
     });
    });

    client.on("error", (err) => {
      console.error("Error MQTT:", err);
      connectionStatus.textContent = "Error de conexi√≥n";
      connectionIcon.textContent = "üî¥";
      showAlert('error', 'Error de conexi√≥n con el servidor');
    });

    client.on("reconnect", () => {
      connectionStatus.textContent = "Reconectando...";
      connectionIcon.textContent = "üü°";
    });

    client.on("message", (topic, message) => {
      try {
        const data = JSON.parse(message.toString());
        
        if (topic === "buses/retrasos") {
          // NOTIFICACI√ìN DE RETRASO DESDE LA APP DEL BUS
          const notificationMsg = `<b>${data.busId}</b>: ${data.motivo}`;
          addNotification(notificationMsg, 'warning');
          return;
        }
        
        const { busId, lat, lon, timestamp } = data;
        if (!busId || !lat || !lon) return;

        // Ignorar mensajes con m√°s de 2 minutos de antig√ºedad
        const messageTime = new Date(timestamp).getTime();
        const currentTime = Date.now();
        const messageAge = currentTime - messageTime;
        
        if (messageAge > 120000) {
          console.log(`Ignorando mensaje antiguo del bus ${busId} (${Math.round(messageAge/1000)} segundos)`);
          return;
        }

        // Actualizar hora de √∫ltima actualizaci√≥n
        lastUpdateTime = new Date().toLocaleTimeString();
        updateStatus.textContent = lastUpdateTime;

        // Procesar datos del bus
        processBusData(busId, parseFloat(lat), parseFloat(lon), timestamp);

        // Verificar notificaciones de proximidad
        checkNotifications(busId, lat, lon);
        
        // ‚úÖ CORREGIDO MEJOR: A√±adir notificaci√≥n de bus disponible SOLO UNA VEZ con control m√°s estricto
        if (!busesNotificados.has(busId)) {
          addNotification(`üöå <b>${busId}</b> est√° disponible en la ruta`, 'bus', busId);
          busesNotificados.add(busId); // Marcar como notificado
          
          // ‚úÖ Establecer como bus activo para centrado manual
          activeBusId = busId;
          centerActiveBusBtn.style.display = 'block';
          centerActiveBusBtn.innerHTML = `<i class="fas fa-bus"></i> ${busId}`;
        }
      } catch (err) {
        console.error('Error procesando mensaje:', err);
      }
    });

    // Actualizar popup del bus
    function updateBusPopup(busId) {
      if (!buses[busId]) return;
      
      const notificacionActiva = notificacionesActivas[busId] ? 
        '<span style="color:#2ed573; font-size:12px;">üîî Notificaci√≥n activa</span>' : 
        '';
      
      const estado = buses[busId].isHistorical ? 
        '<div style="color: #ff6b6b; font-size: 12px; margin: 5px 0;"><i class="fas fa-clock"></i> √öltima posici√≥n conocida</div>' :
        '<div style="color: #2ed573; font-size: 12px; margin: 5px 0;"><i class="fas fa-check-circle"></i> En l√≠nea</div>';
      
      buses[busId].marker.bindPopup(`
        <div class="bus-popup">
          <h4><i class="fas fa-bus"></i> Bus ${busId}</h4>
          <small>Actualizado: ${new Date(buses[busId].lastUpdated).toLocaleTimeString()}</small>
          ${estado}
          ${notificacionActiva}
          <button onclick="activarNotificacion('${busId}')">
            ${notificacionesActivas[busId] ? '‚ùå Cancelar notificaci√≥n' : 'üîî Notificarme cuando est√© cerca'}
          </button>
        </div>
      `);
    }

    // Determinar si se debe actualizar la posici√≥n
    function shouldUpdatePosition(history, newPos) {
      if (history.length === 0) return true;
      
      const lastPos = history[history.length - 1].position;
      const latDiff = Math.abs(lastPos[0] - newPos[0]);
      const lonDiff = Math.abs(lastPos[1] - newPos[1]);
      
      return latDiff > config.movementThreshold || lonDiff > config.movementThreshold;
    }

    // Actualizar posici√≥n del bus
    function updateBusPosition(busId, newPos) {
      if (config.smoothMovement && buses[busId].positions.length > 1) {
        if (notificacionesActivas[busId]) {
          buses[busId].marker.setIcon(L.icon({
            iconUrl: 'imagenes/BUSICONO.jpg?v=1' + Date.now(),
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            className: 'bus-marker-notification'
          }));
        } else {
          buses[busId].marker.setIcon(busIcon);
        }
      }
      
      buses[busId].marker.setLatLng(newPos);
    }

    // Verificar notificaciones de proximidad
    function checkNotifications(busId, lat, lon) {
      
      if (notificacionesActivas[busId] && userCoords) {
        const distancia = calcularDistancia(userCoords[0], userCoords[1], lat, lon);
        
        if (distancia <= config.notificationDistance) {
          const distanciaMetros = Math.round(distancia * 1000);
          
          
          const notificationMsg = ` <b>${busId}</b> est√° a <b>${distanciaMetros} metros</b> de tu ubicaci√≥n`;
          addNotification(notificationMsg, 'success');
          
          if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200]);
          }
          
          playNotificationSound();
          delete notificacionesActivas[busId];
          updateTrackingInfo();
          
          if (buses[busId]?.marker) {
            buses[busId].marker.setIcon(busIcon);
            updateBusPopup(busId);
          }
        }
      }
    }

    // Funci√≥n global para activar notificaciones
    window.activarNotificacion = function(busId) {
      if (!userCoords) {
        showAlert('error', 'No se pudo obtener tu ubicaci√≥n actual.');
        return;
      }

      if (notificacionesActivas[busId]) {
        delete notificacionesActivas[busId];
        if (buses[busId]?.marker) buses[busId].marker.setIcon(busIcon);
        
        // NOTIFICACI√ìN DE CANCELACI√ìN
        addNotification(`üîï Notificaci√≥n cancelada para el <b>${busId}</b>`, 'info');
      } else {
        notificacionesActivas[busId] = true;
        if (buses[busId]?.marker) {
          buses[busId].marker.setIcon(L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            className: 'bus-marker-notification'
          }));
          buses[busId].marker.openPopup();
        }

        // NOTIFICACI√ìN DE ACTIVACI√ìN
        addNotification(`üîî Notificaci√≥n activada para el <b>${busId}</b>`, 'success');

        playNotificationSound();

        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

        if ("Notification" in window && Notification.permission === "granted") {
          new Notification("Visor de Ruta TP10M", {
            body: `Notificaci√≥n activada para el Bus ${busId}`,
            icon: "https://cdn-icons-png.flaticon.com/512/61/61235.png"
          });
        }
      }
      updateBusPopup(busId);
      updateTrackingInfo();
    };

    // Funci√≥n para desactivar notificaci√≥n desde el panel
    window.desactivarNotificacion = function(busId) {
      if (notificacionesActivas[busId]) {
        delete notificacionesActivas[busId];
        if (buses[busId]?.marker) buses[busId].marker.setIcon(busIcon);
        
        // NOTIFICACI√ìN DE CANCELACI√ìN
        addNotification(`üîï Notificaci√≥n cancelada para el <b>${busId}</b>`, 'info');
        updateBusPopup(busId);
        updateTrackingInfo();
      }
    };

    // Funci√≥n para desactivar notificaci√≥n desde el panel de seguimiento
    window.desactivarNotificacionDesdePanel = function(busId) {
      window.desactivarNotificacion(busId);
    };

    // Mostrar alertas
    function showAlert(type, message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i> ${message}`;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.style.animation = 'slideOut 0.3s forwards';
        setTimeout(() => alertDiv.remove(), 300);
      }, 3000);
    }

    // Calcular distancia entre dos puntos
    function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    
    const STOPPED_THRESHOLD = 100 * 1000; 
    const motivos = ["tranc√≥n", "falla mec√°nica", "incidente en la v√≠a"];

    setInterval(() => {
      const now = Date.now();
      
      for (const busId in buses) {
        const bus = buses[busId];
        
        
        if (bus && !bus.isHistorical && busPositionHistory[busId] && busPositionHistory[busId].length > 0) {
          
          
          const uniquePositions = new Set(busPositionHistory[busId].map(pos => pos.positionKey));
          const isStopped = uniquePositions.size === 1; 
          
          
          const stoppedTime = now - busPositionHistory[busId][0].timestamp;
          
          console.log(`Bus ${busId}: ${isStopped ? 'PARADO' : 'EN MOVIMIENTO'}, Tiempo: ${stoppedTime/1000}s`);
          
          
          if (isStopped && stoppedTime > STOPPED_THRESHOLD && !bus.notifiedStopped) {
            console.log(` ALERTA: Bus ${busId} parado por ${Math.round(stoppedTime/1000)} segundos`);
            
            const motivo = motivos[Math.floor(Math.random() * motivos.length)];
            const msg = ` El autob√∫s <b>${busId}</b> est√° presentando inconvenientes para desplazarse (${motivo}), por favor tomar otro autobus`;
            addNotification(msg, 'warning');
            
            // Vibrar para alertar
            if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
            
            bus.notifiedStopped = true;
          }
          
          // ‚úÖ RESETEAR notificaci√≥n si el bus comienza a moverse
          if (!isStopped && bus.notifiedStopped) {
            console.log(`‚úÖ Bus ${busId} reanud√≥ movimiento`);
            bus.notifiedStopped = false;
          }
        }
      }
    }, 1000); // ‚ö° Verificar cada 1 segundo

    // Solicitar permisos de geolocalizaci√≥n al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(requestGeolocationPermission, 1000);
    });
  </script>
</body>
</html>