<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Iniciar Sesi√≥n | Onroute </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    /* Variables de color */
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #34495e;
      --accent-color: #3498db;
      --background-color: #f8f9fa;
      --card-color: #ffffff;
      --text-color: #333333;
      --text-light: #7f8c8d;
      --border-color: #e1e8ed;
      --error-color: #e74c3c;
      --success-color: #2ecc71;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-container {
      background-color: var(--card-color);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 40px;
      width: 100%;
      max-width: 450px;
      transition: transform 0.3s ease;
    }

    .login-container:hover {
      transform: translateY(-5px);
    }

    /* Logo dentro del formulario */
    .form-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 25px;
      gap: 12px;
    }

    .logo-img {
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .logo-text {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary-color);
    }

    h2 {
      text-align: center;
      margin-bottom: 30px;
      color: var(--secondary-color);
      font-weight: 500;
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--secondary-color);
    }

    input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
      background-color: #f8f9fa;
    }

    input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      background-color: white;
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 14px 20px;
      margin: 20px 0;
      cursor: pointer;
      width: 100%;
      font-family: 'Roboto', sans-serif;
      font-size: 16px;
      font-weight: 500;
      transition: background-color 0.3s, transform 0.2s;
    }

    .btn:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-icon {
      margin-right: 10px;
      font-weight: bold;
    }

    /* Estilos para el bot√≥n de Google */
    .google-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: white;
      color: #5f6368;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 14px 16px;
      margin: 16px 0;
      cursor: pointer;
      width: 100%;
      font-family: 'Roboto', sans-serif;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .google-btn:hover {
      background-color: #f8f9fa;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .google-icon {
      margin-right: 12px;
      width: 20px;
      height: 20px;
    }

    .separator {
      display: flex;
      align-items: center;
      text-align: center;
      color: var(--text-light);
      margin: 25px 0;
    }

    .separator::before,
    .separator::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid var(--border-color);
    }

    .separator::before {
      margin-right: .5em;
    }

    .separator::after {
      margin-left: .5em;
    }

    #mensaje {
      padding: 12px 16px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 500;
    }

    .error {
      background-color: rgba(231, 76, 60, 0.1);
      color: var(--error-color);
      border: 1px solid rgba(231, 76, 60, 0.3);
    }

    .success {
      background-color: rgba(46, 204, 113, 0.1);
      color: var(--success-color);
      border: 1px solid rgba(46, 204, 113, 0.3);
    }

    .loading {
      background-color: rgba(52, 152, 219, 0.1);
      color: var(--accent-color);
      border: 1px solid rgba(52, 152, 219, 0.3);
    }

    .footer-links {
      text-align: center;
      margin-top: 25px;
      color: var(--text-light);
      font-size: 14px;
    }

    .footer-links a {
      color: var(--accent-color);
      text-decoration: none;
      transition: color 0.3s;
    }

    .footer-links a:hover {
      color: #2980b9;
      text-decoration: underline;
    }

    @media (max-width: 480px) {
      .login-container {
        padding: 30px 20px;
      }
      
      .logo-text {
        font-size: 24px;
      }
      
      .logo-img {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>

  <div class="login-container">
   
    <div class="form-logo">
      <img src="imagenes/logo.jpg" alt="Logo" 
        style="width: 50px; height: 50px; object-fit: contain;">

    <div class="logo-text">Onruote </div>
    </div>
    
    <h2>Inicia sesi√≥n en tu cuenta</h2>
    
    <div class="input-group">
      <label for="email">Correo electr√≥nico</label>
      <input type="email" id="email" placeholder="tucorreo@ejemplo.com" required>
    </div>
    
    <div class="input-group">
      <label for="password">Contrase√±a</label>
      <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
    </div>
    
    <button class="btn" onclick="iniciarSesion()">
      <span class="btn-icon">‚Üí</span>
      Iniciar sesi√≥n
    </button>
    
    <div class="separator">o</div>
    
    <button class="google-btn" onclick="iniciarSesionGoogle()">
      <img class="google-icon" src="https://developers.google.com/identity/images/g-logo.png" alt="Google logo">
      Iniciar sesi√≥n con Google
    </button>
    
    <div id="mensaje"></div>
    
    <div class="footer-links">
      <a href="registro.html">¬øNo tienes cuenta? Reg√≠strate</a> ‚Ä¢ 
      <a href="recuperar.html">¬øOlvidaste tu contrase√±a?</a>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCgBbH8LrjYGfCOg8sNBaLvekIbicQu_b0",
      authDomain: "bustrackeriot.firebaseapp.com",
      projectId: "bustrackeriot",
      storageBucket: "bustrackeriot.appspot.com",
      messagingSenderId: "263881969617",
      appId: "1:263881969617:web:5d09d1e49f6711f1461af0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // Configurar proveedor de Google
    const provider = new firebase.auth.GoogleAuthProvider();
    
    // Funci√≥n para iniciar sesi√≥n con Google
    function iniciarSesionGoogle() {
      const mensaje = document.getElementById("mensaje");
      
      // Mostrar estado de carga
      mensaje.className = "loading";
      mensaje.textContent = "üîÑ Conectando con Google...";
      
      // Forzar reflow/repaint para asegurar que se muestre
      void mensaje.offsetWidth;
      
      // Peque√±o retardo para asegurar que el mensaje se renderice
      setTimeout(() => {
        auth.signInWithPopup(provider)
          .then((result) => {
            // El usuario ha iniciado sesi√≥n correctamente
            const user = result.user;
            const uid = user.uid;
            
            // Verificar si el usuario ya existe en Firestore
            db.collection("usuarios").doc(uid).get()
              .then((doc) => {
                if (doc.exists) {
                  // El usuario existe, redirigir seg√∫n su tipo
                  const tipo = doc.data().tipo;
                  mensaje.className = "success";
                  mensaje.textContent = "‚úÖ Inicio de sesi√≥n exitoso. Redirigiendo...";
                  
                  setTimeout(() => {
                    window.location.href = tipo === "admin" 
                      ? "registrar_autobus.html" 
                      : "visor_autobuses.html";
                  }, 1500);
                } else {
                  // El usuario no existe en Firestore, crear nuevo registro
                  const nuevoUsuario = {
                    email: user.email,
                    nombre: user.displayName,
                    tipo: "usuario", // Tipo por defecto
                    fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
                  };
                  
                  db.collection("usuarios").doc(uid).set(nuevoUsuario)
                    .then(() => {
                      mensaje.className = "success";
                      mensaje.textContent = "‚úÖ Cuenta creada y sesi√≥n iniciada. Redirigiendo...";
                      
                      setTimeout(() => {
                        window.location.href = "visor_autobuses.html";
                      }, 1500);
                    })
                    .catch((error) => {
                      mensaje.className = "error";
                      mensaje.textContent = "‚ùå Error al crear el perfil: " + error.message;
                    });
                }
              })
              .catch((error) => {
                mensaje.className = "error";
                mensaje.textContent = "‚ùå Error consultando la base de datos: " + error.message;
              });
          })
          .catch((error) => {
            mensaje.className = "error";
            
            // Manejar errores
            if (error.code === 'auth/popup-closed-by-user') {
              mensaje.textContent = "‚ùå El popup de autenticaci√≥n fue cerrado";
            } else {
              mensaje.textContent = "‚ùå Error al iniciar sesi√≥n con Google: " + error.message;
            }
          });
      }, 50);
    }

    function iniciarSesion() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const mensaje = document.getElementById("mensaje");
      
      // Mostrar estado de carga inmediatamente
      mensaje.className = "loading";
      mensaje.textContent = "üîÑ Verificando credenciales...";
      
      // Forzar reflow/repaint para asegurar que se muestre
      void mensaje.offsetWidth;
      
      // Peque√±o retardo para asegurar que el mensaje se renderice
      setTimeout(() => {
        // Validaci√≥n b√°sica
        if (!email || !password) {
          mensaje.className = "error";
          mensaje.textContent = "‚ùå Por favor completa todos los campos";
          return;
        }

        auth.signInWithEmailAndPassword(email, password)
          .then((cred) => {
            const uid = cred.user.uid;

            const unsubscribe = db.collection("usuarios").doc(uid)
              .onSnapshot((doc) => {
                unsubscribe();

                if (doc.exists) {
                  const tipo = doc.data().tipo;
                  mensaje.className = "success";
                  mensaje.textContent = "‚úÖ Inicio de sesi√≥n exitoso. Redirigiendo...";
                  
                  setTimeout(() => {
                    window.location.href = tipo === "admin" 
                      ? "registrar_autobus.html" 
                      : "visor_autobuses.html";
                  }, 1500);
                } else {
                  mensaje.className = "error";
                  mensaje.textContent = "‚ùå No se encontr√≥ el perfil del usuario.";
                }
              }, (error) => {
                mensaje.className = "error";
                mensaje.textContent = "‚ùå Error consultando la base de datos: " + error.message;
              });
          })
          .catch((error) => {
            mensaje.className = "error";
            
            switch(error.code) {
              case "auth/user-not-found":
                mensaje.textContent = "‚ùå No existe una cuenta con este correo";
                break;
              case "auth/wrong-password":
                mensaje.textContent = "‚ùå Contrase√±a incorrecta";
                break;
              case "auth/too-many-requests":
                mensaje.textContent = "‚ùå Demasiados intentos. Intenta m√°s tarde";
                break;
              default:
                mensaje.textContent = "‚ùå Error al iniciar sesi√≥n: " + error.message;
            }
          });
      }, 50);
    }

    // Permitir login con Enter
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        iniciarSesion();
      }
    });
  </script>
</body>
</html>