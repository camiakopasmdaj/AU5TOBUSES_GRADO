<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Administrador - Trazador de Rutas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }
    
    body {
      background-color: #f5f5f5;
      color: #333;
    }
    
    header {
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    header h1 {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    /* Estilos para los botones - MEJORADO PARA M√ìVILES */
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 15px;
      background-color: white;
      border-bottom: 1px solid #e0e0e0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    
    .grupo-botones {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      width: 100%;
    }
    
    .btn {
      padding: 12px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 120px;
      text-align: center;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background-color: #3498db;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #2980b9;
    }
    
    .btn-success {
      background-color: #2ecc71;
      color: white;
    }
    
    .btn-success:hover {
      background-color: #27ae60;
    }
    
    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }
    
    .btn-danger:hover {
      background-color: #c0392b;
    }
    
    .btn-secondary {
      background-color: #95a5a6;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #7f8c8d;
    }
    
    .btn-info {
      background-color: #9b59b6;
      color: white;
    }
    
    .btn-info:hover {
      background-color: #8e44ad;
    }
    
    .btn-warning {
      background-color: #f39c12;
      color: white;
    }
    
    .btn-warning:hover {
      background-color: #d35400;
    }
    
    .separador {
      width: 1px;
      height: 30px;
      background-color: #e0e0e0;
      margin: 0 5px;
    }
    
    /* Estilos para la nueva funcionalidad */
    .rutas-container {
      margin: 15px;
      padding: 15px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .rutas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .rutas-header h3 {
      color: #2c3e50;
      font-weight: 600;
    }
    
    .rutas-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 10px;
      background-color: #f9f9f9;
    }
    
    .ruta-item {
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      background-color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: all 0.2s;
    }
    
    .ruta-item:hover {
      background-color: #f0f7ff;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .ruta-acciones {
      display: flex;
      gap: 5px;
    }
    
    .ruta-acciones button {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ruta-acciones .btn-primary {
      background-color: #3498db;
      color: white;
    }
    
    .ruta-acciones .btn-danger {
      background-color: #e74c3c;
      color: white;
    }
    
    .ruta-acciones .btn-info {
      background-color: #9b59b6;
      color: white;
    }
    
    .oculto {
      display: none;
    }
    
    #map {
      height: calc(100vh - 200px);
      z-index: 1;
    }
    
    .lapiz {
      cursor: crosshair;
    }
    
    .punto-marcador {
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .punto-marcador:hover {
      transform: scale(1.3);
      z-index: 1000;
    }
    
    .modo-eliminacion .punto-marcador {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    .botones-edicion {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      transition: all 0.3s ease;
      overflow: hidden;
      width: 100%;
      margin-top: 10px;
    }
    
    .botones-edicion.oculto {
      max-height: 0;
      opacity: 0;
      margin-top: 0;
    }
    
    .botones-edicion:not(.oculto) {
      max-height: 200px;
      opacity: 1;
    }
    
    /* MEJORAS ESPEC√çFICAS PARA M√ìVILES */
    @media (max-width: 768px) {
      header h1 {
        font-size: 1.2rem;
        text-align: center;
      }
      
      .controls {
        padding: 10px;
        gap: 8px;
      }
      
      .grupo-botones {
        flex-direction: column;
        gap: 8px;
      }
      
      .btn {
        width: 100%;
        padding: 14px 16px;
        font-size: 15px;
      }
      
      .separador {
        display: none;
      }
      
      .botones-edicion {
        flex-direction: column;
      }
      
      #map {
        height: calc(100vh - 250px);
      }
    }
    
    @media (max-width: 480px) {
      .btn {
        font-size: 14px;
        padding: 12px 14px;
      }
      
      .btn span {
        display: inline;
      }
      
      #map {
        height: calc(100vh - 280px);
      }
    }
    
    /* Estilo para el bot√≥n de men√∫ m√≥vil */
    .menu-movil {
      display: none;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 12px;
      font-size: 18px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    
    @media (max-width: 768px) {
      .menu-movil {
        display: block;
        width: 100%;
      }
      
      .botones-edicion.movil-colapsado {
        max-height: 0;
        opacity: 0;
        overflow: hidden;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>üõ†Ô∏è Trazador de Rutas - Sistema de Transporte</h1>
</header>

<div class="controls">
  <div class="grupo-botones">
    <button class="btn btn-secondary" onclick="window.location.href='registrar_autobus.html'">
      Regresar
    </button>
    
    <button class="btn btn-primary" id="btn-editar" onclick="activarModoEdicion()">
       Editar
    </button>
  </div>
  
  
  
  <div class="botones-edicion oculto movil-colapsado" id="botones-edicion">
    <button class="btn btn-info" id="btn-trazar-puntos" onclick="activarTrazadoPuntos()">
       Trazar Puntos
    </button>
    <button class="btn btn-warning" id="btn-eliminar-punto" onclick="activarEliminacionPuntos()">
       Eliminar Punto
    </button>
    <button class="btn btn-warning" onclick="deshacerUltimo()">
      ‚Ü© Deshacer
    </button>
    <button class="btn btn-danger" onclick="eliminarTodo()">
       Eliminar Todo
    </button>
  </div>
</div>


<div id="map"></div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { 
    getDatabase, 
    ref, 
    set, 
    onValue 
  } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

  // üî• Configuraci√≥n Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCgBbH8LrjYGfCOg8sNBaLvekIbicQu_b0",
    authDomain: "bustrackeriot.firebaseapp.com",
    databaseURL: "https://bustrackeriot-default-rtdb.firebaseio.com",
    projectId: "bustrackeriot",
    storageBucket: "bustrackeriot.appspot.com",
    messagingSenderId: "263881969617",
    appId: "1:263881969617:web:5d09d1e49f6711f1461af0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // üó∫Ô∏è Inicializar mapa
  const map = L.map('map').setView([2.44, -76.61], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: "¬© OpenStreetMap"
  }).addTo(map);

  // Variables principales
  let tramos = [];          // cada tramo es un array de puntos [[lat, lng], [lat, lng]]
  let marcadores = [];
  let lineas = [];
  let trazandoPuntos = false;
  let eliminandoPuntos = false;
  let modoEdicionActivo = false;
  let tramoActual = [];     // puntos del tramo que se est√° trazando

  // üöÄ Cargar rutas desde Firebase
  cargarRutasAlInicio();

  // Funci√≥n para el men√∫ m√≥vil
  window.toggleMenuMovil = function() {
    const botonesEdicion = document.getElementById('botones-edicion');
    botonesEdicion.classList.toggle('movil-colapsado');
  };

  function mostrarBotonesEdicion() {
    const botonesEdicion = document.getElementById('botones-edicion');
    botonesEdicion.classList.remove('oculto');
    
    // En m√≥viles, expandir el men√∫ autom√°ticamente
    if (window.innerWidth <= 768) {
      botonesEdicion.classList.remove('movil-colapsado');
    }
  }
  
  function ocultarBotonesEdicion() {
    document.getElementById('botones-edicion').classList.add('oculto');
  }

  // üîÑ Actualizar mapa
  function actualizarMapa() {
    // Limpiar
    marcadores.forEach(m => map.removeLayer(m));
    marcadores = [];
    lineas.forEach(l => map.removeLayer(l));
    lineas = [];

    // Dibujar l√≠neas y puntos
    tramos.forEach((tramo, tIndex) => {
      if (tramo.length > 1) {
        const linea = L.polyline(tramo, { color: 'blue', weight: 5 }).addTo(map);
        lineas.push(linea);
      }

      tramo.forEach((punto, pIndex) => {
        const marcador = L.circleMarker(punto, {
          color: eliminandoPuntos ? 'red' : 'blue',
          fillColor: eliminandoPuntos ? '#ff0000' : '#3388ff',
          fillOpacity: 0.7,
          radius: eliminandoPuntos ? 8 : 6
        }).addTo(map);

        marcador.bindTooltip(`Tramo ${tIndex + 1} - Punto ${pIndex + 1}`, {
          permanent: false,
          direction: 'top'
        });

        if (eliminandoPuntos) {
          marcador.on('click', () => eliminarPunto(tIndex, pIndex));
        }

        marcadores.push(marcador);
      });
    });
  }

  // üß≠ Cargar rutas guardadas
  function cargarRutasAlInicio() {
    const rutasRef = ref(db, 'rutas/');
    onValue(rutasRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        const primeraRuta = Object.keys(data)[0];
        const puntos = data[primeraRuta];
        // reconstruir en tramos (para compatibilidad)
        tramos = [puntos.filter(p => p)];
        actualizarMapa();
        if (puntos.length > 0) {
          map.fitBounds(L.latLngBounds(puntos.filter(p => p)));
        }
      }
    });
  }

  // ‚úèÔ∏è Activar / desactivar edici√≥n
  window.activarModoEdicion = function () {
    modoEdicionActivo = !modoEdicionActivo;
    const btn = document.getElementById('btn-editar');
    if (modoEdicionActivo) {
      mostrarBotonesEdicion();
      btn.classList.replace('btn-primary', 'btn-success');
      btn.innerHTML = 'üíæ Guardar y Salir';
      alert("Modo edici√≥n activado. Usa las herramientas para modificar la ruta.");
    } else {
      guardarCambios();
    }
  };

  // üü¢ Trazar nuevos puntos (nuevo tramo si empieza desde cero)
  window.activarTrazadoPuntos = function () {
    trazandoPuntos = !trazandoPuntos;
    eliminandoPuntos = false;

    const mapEl = document.getElementById('map');
    const btnTrazar = document.getElementById('btn-trazar-puntos');
    const btnEliminar = document.getElementById('btn-eliminar-punto');

    if (trazandoPuntos) {
      mapEl.classList.add('lapiz');
      btnTrazar.classList.replace('btn-info', 'btn-success');
      btnEliminar.classList.replace('btn-danger', 'btn-warning');
      alert("Modo trazado activado. Cada clic comenzar√° o ampliar√° un tramo independiente.");
      tramoActual = [];
      tramos.push(tramoActual);
    } else {
      mapEl.classList.remove('lapiz');
      btnTrazar.classList.replace('btn-success', 'btn-info');
      tramoActual = [];
    }

    actualizarMapa();
  };

  // üî¥ Modo eliminar
  window.activarEliminacionPuntos = function () {
    eliminandoPuntos = !eliminandoPuntos;
    trazandoPuntos = false;

    const btnEliminar = document.getElementById('btn-eliminar-punto');
    const btnTrazar = document.getElementById('btn-trazar-puntos');

    if (eliminandoPuntos) {
      btnEliminar.classList.replace('btn-warning', 'btn-danger');
      btnTrazar.classList.replace('btn-success', 'btn-info');
      alert("Modo eliminaci√≥n activado. Haz clic en cualquier punto para eliminarlo.");
    } else {
      btnEliminar.classList.replace('btn-danger', 'btn-warning');
    }

    actualizarMapa();
  };

  // üóëÔ∏è Eliminar punto espec√≠fico
  function eliminarPunto(tIndex, pIndex) {
    if (!confirm(`¬øEliminar el punto ${pIndex + 1} del tramo ${tIndex + 1}?`)) return;

    const tramo = tramos[tIndex];

    // üß† Si el punto est√° en medio, partir el tramo en dos
    if (pIndex > 0 && pIndex < tramo.length - 1) {
      const primeraParte = tramo.slice(0, pIndex);
      const segundaParte = tramo.slice(pIndex + 1);

      // Reemplazamos el tramo actual por las dos mitades
      tramos.splice(tIndex, 1);
      let insertIndex = tIndex;

      if (primeraParte.length > 0) {
        tramos.splice(insertIndex, 0, primeraParte);
        insertIndex++;
      }
      if (segundaParte.length > 0) {
        tramos.splice(insertIndex, 0, segundaParte);
      }
    } else {
      // üü¢ Si es primero o √∫ltimo, eliminar directamente
      tramo.splice(pIndex, 1);
      if (tramo.length === 0) {
        tramos.splice(tIndex, 1);
      }
    }

    actualizarMapa();
  }

  // ‚ûï A√±adir punto con clic
  map.on('click', function (e) {
    if (!trazandoPuntos || eliminandoPuntos) return;
    if (!tramoActual) {
      tramoActual = [];
      tramos.push(tramoActual);
    }
    tramoActual.push([e.latlng.lat, e.latlng.lng]);
    actualizarMapa();
  });

  // üíæ Guardar cambios en Firebase
  function guardarCambios() {
    const todosPuntos = tramos.flat();
    if (todosPuntos.length < 2) {
      alert("Debe haber al menos dos puntos para guardar la ruta.");
      return;
    }

    const nombreRuta = prompt("Nombre de la ruta:", "Ruta Principal");
    if (!nombreRuta) return;

    set(ref(db, 'rutas/' + nombreRuta), todosPuntos)
      .then(() => {
        alert("Ruta guardada correctamente.");
        salirModoEdicion();
      })
      .catch((err) => alert("Error: " + err.message));
  }

  // ‚Ü©Ô∏è Deshacer √∫ltimo punto
  window.deshacerUltimo = function () {
    if (tramos.length > 0) {
      const ultimo = tramos[tramos.length - 1];
      if (ultimo.length > 0) {
        ultimo.pop();
      } else {
        tramos.pop();
      }
      actualizarMapa();
    } else {
      alert("No hay puntos que deshacer.");
    }
  };

  // ‚ùå Eliminar todo
  window.eliminarTodo = function () {
    if (confirm("¬øEliminar todos los tramos y puntos?")) {
      tramos = [];
      tramoActual = [];
      actualizarMapa();
    }
  };

  // üö™ Salir del modo edici√≥n
  function salirModoEdicion() {
    modoEdicionActivo = false;
    trazandoPuntos = false;
    eliminandoPuntos = false;
    tramoActual = [];

    const btnEditar = document.getElementById('btn-editar');
    btnEditar.classList.replace('btn-success', 'btn-primary');
    btnEditar.innerHTML = '‚úèÔ∏è Editar';

    ocultarBotonesEdicion();
    actualizarMapa();
  }
</script>
</body>
</html>