<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Onroute - Encuentra tu destino</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    /* Estilos generales optimizados para m√≥vil */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: #0c0c0c;
      color: #f5f5f5;
      line-height: 1.4;
      min-height: 100vh;
      overflow: hidden;
      touch-action: manipulation;
    }

    /* Header fijo para m√≥vil */
    header {
      background: #1a1a1a;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #333;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      height: 60px;
    }

    .btn-regresar {
      background: #333;
      color: #f0f0f0;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 12px;
      font-weight: 500;
      font-size: 16px;
    }

    .header-content {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .logo {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      object-fit: cover;
      margin-right: 10px;
    }

    header h2 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #f5f5f5;
    }

    /* Contenedor principal optimizado para m√≥vil */
    main {
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding-top: 60px; /* Compensa el header fijo */
    }

    /* B√∫squeda compacta */
    .search-container {
      background: #1a1a1a;
      padding: 15px;
      border-bottom: 1px solid #333;
    }

    .search-container label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 0.95rem;
      color: #e0e0e0;
    }

    .search-container input {
      width: 100%;
      padding: 12px 14px;
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 8px;
      color: #f0f0f0;
      font-size: 16px; /* Previene zoom en iOS */
      margin-bottom: 10px;
    }

    .search-container input:focus {
      outline: none;
      border-color: #666;
    }

    /* Sugerencias optimizadas para touch */
    #sugerencias {
      list-style: none;
      background: #2a2a2a;
      border-radius: 8px;
      border: 1px solid #444;
      max-height: 150px;
      overflow-y: auto;
    }

    #sugerencias li {
      padding: 12px 14px;
      border-bottom: 1px solid #3a3a3a;
      cursor: pointer;
      font-size: 0.9rem;
    }

    #sugerencias li:last-child {
      border-bottom: none;
    }

    #sugerencias li:active {
      background-color: #3a3a3a;
    }

    /* Mapa ocupa todo el espacio disponible */
    .map-container {
      flex: 1;
      position: relative;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    /* Panel de botones inferior optimizado para m√≥vil */
    .bottom-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(26, 26, 26, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid #333;
      padding: 15px;
      z-index: 1000;
    }

    .button-group {
      display: flex;
      gap: 10px;
    }

    .bottom-panel button {
      flex: 1;
      background: #333;
      color: #f0f0f0;
      border: none;
      padding: 14px;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .bottom-panel button:active {
      background: #444;
      transform: scale(0.98);
    }

    #btnRutaTP10M {
      background: #4e4e4e;
    }

    #btnRutaTP10M:active {
      background: #000000;
    }

    /* Panel de informaci√≥n optimizado para m√≥vil */
    .route-info {
      position: fixed;
      bottom: 80px; /* Por encima de los botones */
      left: 10px;
      right: 10px;
      background: rgba(26, 26, 26, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid #444;
      border-radius: 12px;
      padding: 16px;
      z-index: 999;
      display: none;
      max-height: 60vh;
      overflow-y: auto;
    }

    .route-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #444;
    }

    .route-header h3 {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .close-btn {
      background: none;
      border: none;
      color: #aaa;
      font-size: 1.3rem;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .close-btn:active {
      background-color: #333;
    }

    .route-details {
      margin-top: 12px;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 6px 0;
    }

    .detail-label {
      color: #aaa;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .detail-value {
      color: #f0f0f0;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .route-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }

    .stat-box {
      background: #2a2a2a;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      border-left: 4px solid #4a7c59;
    }

    .stat-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: #4a7c59;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #aaa;
    }

    /* Estados de carga y mensajes */
    .loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 2000;
    }

    /* Scrollbar m√≥vil */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #2a2a2a;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 3px;
    }

    /* Safe areas para iPhone X+ */
    @supports (padding: max(0px)) {
      .bottom-panel {
        padding-bottom: max(15px, env(safe-area-inset-bottom));
      }
    }

    /* Animaciones suaves */
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .slide-up {
      animation: slideUp 0.3s ease-out;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
</head>
<body>

  <!-- Header fijo -->
  <header>
    <button class="btn-regresar" onclick="window.location.href='visor_autobuses.html'">‚Üê</button>
    <div class="header-content">
      <img src="imagenes/logo.jpg" alt="Logo Onroute" class="logo">
      <h2>Encuentra tu destino</h2>
    </div>
  </header>

  <main>
    
    <div class="search-container">
      <label for="destino">Ingresa tu destino:</label>
      <input type="text" id="destino" placeholder="Ejemplo: Parque Caldas, Universidad...">
      <ul id="sugerencias"></ul>
    </div>

    <div class="map-container">
      <div id="map"></div>
    </div>

   
    <div class="route-info slide-up" id="routeInfo">
      <div class="route-header">
        <h3 id="routeTitle">Ruta TP10M</h3>
        <button class="close-btn" onclick="cerrarPanelRuta()">√ó</button>
      </div>
      <p id="routeDescription">Ruta principal que conecta el norte y sur de la ciudad.</p>
      
      <div class="route-details">
        <div class="detail-item">
          <span class="detail-label">Origen:</span>
          <span class="detail-value" id="routeOrigin">Terminal Norte</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Destino:</span>
          <span class="detail-value" id="routeDestination">Terminal Sur</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Frecuencia:</span>
          <span class="detail-value" id="routeFrequency">15-20 min</span>
        </div>
      </div>
      
      <div class="route-stats">
        <div class="stat-box">
          <div class="stat-value" id="routeDistance">12.5 km</div>
          <div class="stat-label">Distancia</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="routeDuration">45 min</div>
          <div class="stat-label">Duraci√≥n</div>
        </div>
      </div>
    </div>

    <!-- Panel de botones inferior fijo -->
    <div class="bottom-panel">
      <div class="button-group">
        <button onclick="buscarDestinos()">Buscar destino</button>
        <button id="btnRutaTP10M" onclick="mostrarRutaTP10M()">Ruta TP10M</button>
      </div>
    </div>

    <!-- Indicador de carga -->
    <div class="loading" id="loading">Cargando...</div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>

  <script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCgBbH8LrjYGfCOg8sNBaLvekIbicQu_b0",
      authDomain: "bustrackeriot.firebaseapp.com",
      databaseURL: "https://bustrackeriot-default-rtdb.firebaseio.com",
      projectId: "bustrackeriot",
      storageBucket: "bustrackeriot.appspot.com",
      messagingSenderId: "263881969617",
      appId: "1:263881969617:web:5d09d1e49f6711f1461af0"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Configuraci√≥n del mapa
    const map = L.map("map").setView([2.4382, -76.6131], 14);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "¬© OpenStreetMap"
    }).addTo(map);

    // Variables globales
    let userMarker = null;
    let destinoMarker = null;
    let controlRuta = null;
    let ubicacionUsuario = null;
    let rutaActual = null;
    let rutaTP10M = null;
    let markersTP10M = [];

    // Iconos personalizados
    const userIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
    });

    const destinoIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
    });

    const busIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
    });

    // Obtener ubicaci√≥n del usuario
    function obtenerUbicacionUsuario() {
      if (navigator.geolocation) {
        mostrarLoading(true);
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            ubicacionUsuario = [latitude, longitude];
            userMarker = L.marker(ubicacionUsuario, {icon: userIcon})
              .addTo(map)
              .bindPopup("üìç Tu ubicaci√≥n actual")
              .openPopup();
            map.setView(ubicacionUsuario, 15);
            document.getElementById("btnRutaTP10M").style.display = "block";
            mostrarLoading(false);
          },
          (err) => {
            console.error("No se pudo obtener la ubicaci√≥n:", err);
            alert("No se pudo obtener tu ubicaci√≥n actual.");
            mostrarLoading(false);
            // Ubicaci√≥n por defecto (Popay√°n)
            ubicacionUsuario = [2.4382, -76.6131];
            userMarker = L.marker(ubicacionUsuario, {icon: userIcon})
              .addTo(map)
              .bindPopup("üìç Centro de Popay√°n")
              .openPopup();
            map.setView(ubicacionUsuario, 14);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
          }
        );
      } else {
        alert("La geolocalizaci√≥n no es soportada por este navegador.");
      }
    }

    // Funciones principales - CORREGIDAS
    function buscarDestinos() {
      const query = document.getElementById("destino").value.trim();
      const lista = document.getElementById("sugerencias");
      lista.innerHTML = "";

      if (query.length < 2) {
        alert("Escribe al menos 2 caracteres para buscar.");
        return;
      }

      mostrarLoading(true);
      
      // URL CORREGIDA - usando el formato correcto de Nominatim
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=5&addressdetails=1&q=${encodeURIComponent(query + ', Popay√°n, Colombia')}`;
      
      console.log("Buscando con URL:", url); // Para debug
      
      fetch(url)
        .then(res => {
          if (!res.ok) {
            throw new Error(`Error HTTP: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          mostrarLoading(false);
          console.log("Resultados encontrados:", data); // Para debug
          
          if (data.length === 0) {
            lista.innerHTML = "<li>No se encontraron resultados. Intenta con otras palabras.</li>";
            return;
          }

          data.slice(0, 5).forEach(item => {
            const li = document.createElement("li");
            li.textContent = item.display_name.length > 60 ? 
              item.display_name.substring(0, 60) + "..." : 
              item.display_name;
            li.addEventListener("click", () => mostrarEnMapa(item));
            lista.appendChild(li);
          });
        })
        .catch(err => {
          mostrarLoading(false);
          console.error("Error en b√∫squeda:", err);
          // Mensaje m√°s espec√≠fico del error
          if (err.message.includes('Failed to fetch')) {
            alert("Error de conexi√≥n. Verifica tu conexi√≥n a internet.");
          } else if (err.message.includes('HTTP')) {
            alert("Error del servidor. Intenta nuevamente.");
          } else {
            alert("Error al buscar destinos: " + err.message);
          }
        });
    }

    function mostrarEnMapa(item) {
      const lat = parseFloat(item.lat);
      const lon = parseFloat(item.lon);

      // Limpiar elementos anteriores
      if (destinoMarker) map.removeLayer(destinoMarker);
      if (controlRuta) map.removeControl(controlRuta);

      // Crear marcador de destino
      destinoMarker = L.marker([lat, lon], {icon: destinoIcon})
        .addTo(map)
        .bindPopup(`üìç ${item.display_name}`)
        .openPopup();

      map.setView([lat, lon], 16);
      document.getElementById("sugerencias").innerHTML = "";

      // Calcular ruta si tenemos ubicaci√≥n del usuario
      if (ubicacionUsuario) {
        calcularRutaUsuario(ubicacionUsuario, [lat, lon]);
      }
    }

    function calcularRutaUsuario(origen, destino) {
      if (controlRuta) {
        map.removeControl(controlRuta);
      }

      controlRuta = L.Routing.control({
        waypoints: [
          L.latLng(origen[0], origen[1]),
          L.latLng(destino[0], destino[1])
        ],
        lineOptions: {
          styles: [{ color: '#2196F3', weight: 5, opacity: 0.7 }]
        },
        language: 'es',
        show: false,
        addWaypoints: false,
        routeWhileDragging: false,
        draggableWaypoints: false,
        createMarker: () => null
      }).addTo(map);

      controlRuta.on('routesfound', function(e) {
        const route = e.routes[0];
        const distanciaKm = (route.summary.totalDistance / 1000).toFixed(2);
        const duracionMin = Math.round(route.summary.totalTime / 60);
        
        mostrarInfoRutaUsuario(distanciaKm, duracionMin);
      });
    }

    function mostrarInfoRutaUsuario(distancia, duracion) {
      const routeInfo = document.getElementById('routeInfo');
      
      document.getElementById('routeTitle').textContent = 'Ruta hacia tu destino';
      document.getElementById('routeDescription').textContent = 'Ruta calculada desde tu ubicaci√≥n actual hasta el destino seleccionado.';
      
      document.getElementById('routeOrigin').textContent = 'Tu ubicaci√≥n';
      if (destinoMarker) {
        const destinoTexto = destinoMarker.getPopup().getContent().replace('üìç ', '');
        document.getElementById('routeDestination').textContent = 
          destinoTexto.length > 30 ? destinoTexto.substring(0, 30) + "..." : destinoTexto;
      }
      
      document.getElementById('routeDistance').textContent = `${distancia} km`;
      document.getElementById('routeDuration').textContent = `${duracion} min`;
      
      routeInfo.style.display = 'block';
    }

    function mostrarRutaTP10M() {
      if (!ubicacionUsuario) {
        alert("Obteniendo tu ubicaci√≥n...");
        obtenerUbicacionUsuario();
        return;
      }

      mostrarLoading(true);

      database.ref("rutas/TP10M").once("value").then((snapshot) => {
        mostrarLoading(false);
        const puntosRutaTP10M = snapshot.val();
        
        if (!puntosRutaTP10M || puntosRutaTP10M.length === 0) {
          alert("No se encontr√≥ la ruta TP10M en la base de datos.");
          return;
        }

        // Limpiar elementos anteriores
        if (rutaTP10M) map.removeLayer(rutaTP10M);
        markersTP10M.forEach(marker => map.removeLayer(marker));
        markersTP10M = [];

        // Dibujar ruta TP10M
        rutaTP10M = L.polyline(puntosRutaTP10M, {
          color: '#4CAF50',
          weight: 6,
          opacity: 0.8
        }).addTo(map).bindPopup(`<b>Ruta TP10M</b>`);

        // Calcular distancia total
        let distanciaTotal = 0;
        for (let i = 1; i < puntosRutaTP10M.length; i++) {
          distanciaTotal += calcularDistancia(
            puntosRutaTP10M[i-1][0], puntosRutaTP10M[i-1][1],
            puntosRutaTP10M[i][0], puntosRutaTP10M[i][1]
          );
        }

        // Ajustar vista
        const bounds = L.latLngBounds(puntosRutaTP10M);
        if (userMarker) bounds.extend(userMarker.getLatLng());
        map.fitBounds(bounds, { padding: [20, 20] });

        // Mostrar informaci√≥n
        mostrarInfoRutaTP10M(distanciaTotal);
        
      }).catch(error => {
        mostrarLoading(false);
        console.error("Error al obtener la ruta TP10M:", error);
        alert("Error al cargar la ruta TP10M.");
      });
    }

    function mostrarInfoRutaTP10M(distanciaTotal) {
      const routeInfo = document.getElementById('routeInfo');
      
      document.getElementById('routeTitle').textContent = 'Ruta TP10M';
      document.getElementById('routeDescription').textContent = 'Ruta principal que conecta el norte y sur de Popay√°n.';
      
      document.getElementById('routeOrigin').textContent = 'Terminal Norte';
      document.getElementById('routeDestination').textContent = 'Terminal Sur';
      document.getElementById('routeFrequency').textContent = '15-20 min';
      
      const duracionEstimada = Math.round((distanciaTotal / 20) * 60);
      document.getElementById('routeDistance').textContent = `${distanciaTotal.toFixed(1)} km`;
      document.getElementById('routeDuration').textContent = `${duracionEstimada} min`;
      
      routeInfo.style.display = 'block';
    }

    function cerrarPanelRuta() {
      document.getElementById('routeInfo').style.display = 'none';
    }

    function mostrarLoading(mostrar) {
      document.getElementById('loading').style.display = mostrar ? 'block' : 'none';
    }

    // Funci√≥n utilitaria
    function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Inicializar aplicaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
      obtenerUbicacionUsuario();
      
      // Evento para buscar con Enter
      document.getElementById('destino').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          buscarDestinos();
        }
      });

      // Tambi√©n buscar cuando el input cambia (b√∫squeda en tiempo real)
      let searchTimeout;
      document.getElementById('destino').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        
        if (query.length >= 2) {
          searchTimeout = setTimeout(() => {
            buscarDestinos();
          }, 500); // Espera 500ms despu√©s de que el usuario deje de escribir
        }
      });
    });
  </script>
</body>
</html>